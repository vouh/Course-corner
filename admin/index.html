<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Course Corner</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="icon" href="../favicon.ico" sizes="any">
    <link rel="manifest" href="../site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="js/admin-auth.js"></script>
    <script src="js/learn-admin.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
                            400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
                            800: '#166534', 900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #374151;
            border-top-color: #22c55e;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .stat-gradient-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-gradient-2 {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .stat-gradient-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-gradient-4 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .table-row:hover {
            background: rgba(34, 197, 94, 0.05);
        }

        .dark .table-row:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .sidebar {
            transition: transform 0.3s ease, width 0.3s ease;
        }

        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
        }

        .dark .hover-lift:hover {
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.4);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slide-in 0.3s ease;
        }

        /* ═══ COMPACT LAYOUT FOR LAPTOP SCREENS ═══ */
        @media (min-width:1024px) {
            aside#sidebar { width:220px !important; }
            .lg\:ml-72 { margin-left:220px !important; }
        }
        /* Sidebar header */
        aside#sidebar > div:first-child { height:3.25rem !important; padding:.5rem 1rem !important; }
        aside#sidebar > div:first-child img { width:1.75rem !important; height:1.75rem !important; border-radius:.5rem !important; }
        aside#sidebar > div:first-child h1 { font-size:.875rem !important; }
        aside#sidebar > div:first-child p { font-size:.6rem !important; }
        /* Sidebar nav items */
        aside#sidebar .nav-item { padding:.375rem .65rem !important; gap:.55rem !important; font-size:.78rem !important; border-radius:.6rem !important; }
        aside#sidebar .nav-item > i:first-child { font-size:.78rem !important; width:.85rem !important; min-width:.85rem; }
        aside#sidebar nav > div > p { font-size:.58rem !important; margin-bottom:.35rem !important; padding-left:.65rem !important; }
        /* Top bar */
        header.sticky.h-20 { height:3.25rem !important; padding-left:1.25rem !important; padding-right:1.25rem !important; }
        header.sticky.h-20 #page-title { font-size:1.05rem !important; }
        header.sticky.h-20 #page-subtitle { font-size:.68rem !important; }
        header.sticky.h-20 button.p-3 { padding:.45rem !important; }
        header.sticky.h-20 button.p-3 i { font-size:.8rem !important; }
        header.sticky.h-20 #topbar-email { font-size:.75rem !important; max-width:120px !important; }
        /* Stat cards */
        [class*="stat-gradient-"] { width:2.25rem !important; height:2.25rem !important; border-radius:.6rem !important; }
        [class*="stat-gradient-"] i { font-size:.8rem !important; }
        .hover-lift { padding:.9rem !important; }
        .hover-lift .mb-4 { margin-bottom:.6rem !important; }
        #page-dashboard .text-4xl { font-size:1.5rem !important; line-height:1.2 !important; }
        #page-dashboard .grid.gap-6 { gap:.9rem !important; margin-bottom:1.25rem !important; }
        /* Main page padding */
        main.p-4.lg\:p-8 { padding:1.25rem !important; }
        main table th, main table td { padding:.6rem 1rem !important; font-size:.78rem !important; }
        main table th { font-size:.65rem !important; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-2 sm:p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-4 sm:mb-8">
                <img src="../assets/images/logo.png" alt="Course Corner"
                    class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-3 sm:mb-4 rounded-2xl shadow-lg">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Course Corner</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1 sm:mt-2 text-sm sm:text-base">Admin Dashboard</p>
            </div>

            <div
                class="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-xl p-4 sm:p-8 border border-gray-100 dark:border-gray-700">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4 sm:mb-6">Welcome back</h2>

                <form id="login-form" class="space-y-3 sm:space-y-5">
                    <div>
                        <label
                            class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 sm:mb-2">
                            <i class="fas fa-envelope mr-2 text-primary-500"></i>Email Address
                        </label>
                        <input type="email" id="login-email" required
                            class="w-full px-3 sm:px-4 py-3 sm:py-4 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg sm:rounded-xl text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm sm:text-base"
                            placeholder="admin@coursecorner.com">
                    </div>

                    <div>
                        <label
                            class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 sm:mb-2">
                            <i class="fas fa-lock mr-2 text-primary-500"></i>Password
                        </label>
                        <input type="password" id="login-password" required
                            class="w-full px-3 sm:px-4 py-3 sm:py-4 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg sm:rounded-xl text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm sm:text-base"
                            placeholder="••••••••">
                    </div>

                    <div id="login-error"
                        class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-xl text-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="login-error-message"></span>
                    </div>

                    <button type="submit" id="login-btn"
                        class="w-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-3 sm:py-4 rounded-lg sm:rounded-xl font-bold text-base sm:text-lg shadow-lg shadow-primary-500/30 hover:shadow-primary-500/50 transition-all flex items-center justify-center gap-2">
                        <span id="login-btn-text">Sign In</span>
                        <i id="login-spinner" class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </form>

                <div
                    class="mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-gray-100 dark:border-gray-700 flex items-center justify-center gap-4">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Theme:</span>
                    <button onclick="toggleTheme()"
                        class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-sun dark:hidden"></i>
                        <i class="fas fa-moon hidden dark:inline"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed left-0 top-0 h-full w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-40 sidebar -translate-x-full lg:translate-x-0">
            <div class="h-20 flex items-center gap-3 px-6 border-b border-gray-200 dark:border-gray-700">
                <img src="../assets/images/logo.png" alt="Course Corner" class="w-12 h-12 rounded-xl shadow-lg">
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Course Corner</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Admin Panel</p>
                </div>
            </div>

            <nav class="p-4 space-y-2 overflow-y-auto" style="max-height: calc(100vh - 5rem);">
                <!-- Main Tools Section -->
                <div id="section-main">
                    <p class="px-4 text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.15em] mb-2">Main Platform</p>
                    <a href="#" onclick="switchPage('dashboard')" id="nav-dashboard"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-chart-pie text-xl w-6"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" onclick="switchPage('transactions')" id="nav-transactions"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-receipt text-xl w-6"></i>
                        <span>Transactions</span>
                    </a>
                    <a href="referrals.html" id="nav-referrals"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-users text-xl w-6"></i>
                        <span>Referrals</span>
                    </a>
                    <a href="withdrawals.html" id="nav-withdrawals"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-money-bill-wave text-xl w-6"></i>
                        <span>Withdrawals</span>
                    </a>
                </div>

                <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="px-4 text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.15em] mb-2">Learn Portal</p>
                    <a id="nav-learn" href="#" onclick="switchPage('learn'); return false;"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-graduation-cap text-xl w-6"></i>
                        <span>Learn Admin</span>
                        <i class="fas fa-arrow-right text-xs ml-auto opacity-40"></i>
                    </a>
                    <a href="../Learn/index.html" target="_blank"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium opacity-60">
                        <i class="fas fa-external-link-alt text-xl w-6"></i>
                        <span>Public Portal ↗</span>
                    </a>
                </div>

                <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <p
                        class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2">
                        Admin Tools</p>
                    <a href="referral-codes.html"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-ticket-alt text-xl w-6"></i>
                        <span>All Referral Codes</span>
                    </a>
                    <a href="#" onclick="openCodeGenerator()"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-gift text-xl w-6"></i>
                        <span>Code Generator</span>
                    </a>
                    <a href="magic-links.html"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-link text-xl w-6"></i>
                        <span>Magic Links</span>
                    </a>
                </div>
            </nav>

            <div class="p-4 border-t border-gray-200 dark:border-gray-700 mt-2">
                <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all font-medium text-sm">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:ml-72 min-h-screen">
            <!-- Top Bar -->
            <header
                class="h-20 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30 px-4 lg:px-8 flex items-center justify-between">
                <button onclick="toggleSidebar()"
                    class="lg:hidden p-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <div class="hidden lg:block">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h2>
                    <p id="page-subtitle" class="text-sm text-gray-500 dark:text-gray-400">Overview of your business</p>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="refreshData()"
                        class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Refresh">
                        <i class="fas fa-sync-alt text-lg"></i>
                    </button>
                    <button onclick="toggleTheme()"
                        class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Toggle Theme">
                        <i class="fas fa-sun text-lg dark:hidden"></i>
                        <i class="fas fa-moon text-lg hidden dark:inline"></i>
                    </button>
                    <div class="hidden sm:flex items-center gap-3 pl-3 border-l border-gray-200 dark:border-gray-700 relative" id="admin-account-area">
                        <button onclick="document.getElementById('adminAccountDropdown').classList.toggle('hidden')" class="flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <div class="w-8 h-8 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white text-xs"></i>
                            </div>
                            <span id="topbar-email" class="text-sm font-medium text-gray-700 dark:text-gray-300 max-w-[160px] truncate">Admin</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                        </button>
                        <div id="adminAccountDropdown" class="hidden absolute top-[calc(100%+8px)] right-0 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 z-50 py-1">
                            <div class="px-4 py-2 border-b border-gray-100 dark:border-gray-700">
                                <p id="dropdown-email" class="text-xs font-semibold text-gray-700 dark:text-gray-300 truncate">admin@email.com</p>
                                <p class="text-[10px] text-gray-400">Administrator</p>
                            </div>
                            <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                <i class="fas fa-sign-out-alt"></i> Sign Out
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden">
            </div>

            <main class="p-4 lg:p-8">
                <!-- Dashboard Page -->
                <div id="page-dashboard">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 stat-gradient-1 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-receipt text-white text-2xl"></i>
                                </div>
                                <span
                                    class="text-xs font-medium text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-lg">All
                                    Time</span>
                            </div>
                            <p id="stat-total" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Transactions</p>
                        </div>

                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 stat-gradient-2 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-check-circle text-white text-2xl"></i>
                                </div>
                                <span class="flex items-center gap-1 text-green-500 text-sm font-medium">
                                    <i class="fas fa-arrow-up text-xs"></i>
                                    <span id="stat-completed-pct">0%</span>
                                </span>
                            </div>
                            <p id="stat-completed" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Completed</p>
                        </div>

                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 stat-gradient-4 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-times-circle text-white text-2xl"></i>
                                </div>
                                <span class="relative flex h-3 w-3">
                                    <span
                                        class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                            </div>
                            <p id="stat-failed" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Failed</p>
                        </div>

                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 bg-gradient-to-br from-emerald-400 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-coins text-white text-2xl"></i>
                                </div>
                                <span
                                    class="text-xs font-medium text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg">Revenue</span>
                            </div>
                            <p id="stat-revenue" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Revenue</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <button onclick="exportToCSV()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-file-csv text-blue-600 dark:text-blue-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Export</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Download CSV</p>
                            </div>
                        </button>

                        <button onclick="exportToPDF()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-file-pdf text-red-600 dark:text-red-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Report</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Generate PDF</p>
                            </div>
                        </button>

                        <button onclick="openCodeGenerator()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-magic text-purple-600 dark:text-purple-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Generate</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Referral Code</p>
                            </div>
                        </button>

                    </div>

                    <!-- Recent Transactions -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div
                            class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Recent Transactions</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Latest payment activities</p>
                            </div>
                            <a href="#" onclick="switchPage('transactions')"
                                class="text-primary-600 hover:text-primary-700 dark:text-primary-400 font-medium text-sm">
                                View All <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                        <div id="recent-transactions" class="divide-y divide-gray-100 dark:divide-gray-700">
                            <div class="p-8 text-center">
                                <div class="loader mx-auto mb-4"></div>
                                <p class="text-gray-500 dark:text-gray-400">Loading transactions...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Page -->
                <div id="page-transactions" class="hidden">
                    <div
                        class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2 flex gap-2">
                                <div class="relative flex-1">
                                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="search-input" placeholder="Search phone, M-Pesa code, or ID..."
                                        class="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white"
                                        onkeyup="handleSearch()">
                                </div>
                                <button onclick="handleSearch()" class="px-5 bg-primary-500 hover:bg-primary-600 text-white rounded-xl transition-all shadow-lg shadow-primary-500/20">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="bulk-actions"
                                    class="hidden flex items-center gap-2 px-4 py-1 bg-primary-50 dark:bg-primary-900/20 border border-primary-100 dark:border-primary-800 rounded-xl animate-slide-in">
                                    <span id="selected-count"
                                        class="text-sm font-bold text-primary-700 dark:text-primary-300">0</span>
                                    <button onclick="deleteSelectedTransactions()"
                                        class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                                        title="Delete Selected">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <select id="status-filter" onchange="applyAllFilters()"
                                    class="px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <select id="category-filter" onchange="applyAllFilters()"
                                class="px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                                <option value="">All Packages</option>
                                <option value="calculate-cluster-points">Starter</option>
                                <option value="courses-only">Standard</option>
                                <option value="point-and-courses">Premium</option>
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold">Gold</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">From
                                    Date</label>
                                <input type="date" id="date-from" onchange="applyAllFilters()"
                                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">To
                                    Date</label>
                                <input type="date" id="date-to" onchange="applyAllFilters()"
                                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                            </div>
                            <div class="flex items-end">
                                <button onclick="clearAllFilters()"
                                    class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-times mr-2"></i>Clear
                                </button>
                            </div>
                            <div class="flex items-end">
                                <div class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-xl text-center">
                                    <span id="results-count" class="text-sm text-gray-600 dark:text-gray-300">0
                                        results</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-4 text-left">
                                            <input type="checkbox" id="select-all-transactions"
                                                onchange="toggleSelectAllTransactions()"
                                                class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        </th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Date</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Phone</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Amount</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Package</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            M-Pesa Code</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Referral</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="9" class="px-6 py-12 text-center">
                                            <div class="loader mx-auto mb-4"></div>
                                            <p class="text-gray-500 dark:text-gray-400">Loading...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="empty-state" class="hidden p-12 text-center">
                            <div
                                class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-inbox text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Transactions Found
                            </h3>
                            <p class="text-gray-500 dark:text-gray-400">Try adjusting your filters</p>
                        </div>
                    </div>
                </div>
                <!-- Learn Portal Management Page -->
                <div id="page-learn" class="hidden">
                    <!-- Header stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400 text-xl"><i class="fas fa-users"></i></div>
                            <div><p class="text-2xl font-extrabold text-gray-900 dark:text-white" id="learn-stat-total">—</p><p class="text-xs text-gray-500">Total Applications</p></div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 dark:text-yellow-400 text-xl"><i class="fas fa-clock"></i></div>
                            <div><p class="text-2xl font-extrabold text-gray-900 dark:text-white" id="learn-stat-pending">—</p><p class="text-xs text-gray-500">Pending Review</p></div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 text-xl"><i class="fas fa-check-circle"></i></div>
                            <div><p class="text-2xl font-extrabold text-gray-900 dark:text-white" id="learn-stat-approved">—</p><p class="text-xs text-gray-500">Approved</p></div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 text-xl"><i class="fas fa-book"></i></div>
                            <div><p class="text-2xl font-extrabold text-gray-900 dark:text-white" id="learn-stat-courses">—</p><p class="text-xs text-gray-500">Active Courses</p></div>
                        </div>
                    </div>
                    <!-- Applications table -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 mb-6">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex flex-wrap items-center justify-between gap-3">
                            <div>
                                <h2 class="text-lg font-bold text-gray-900 dark:text-white">Learn Applications</h2>
                                <p class="text-sm text-gray-500 mt-0.5">Review and manage student applications</p>
                            </div>
                            <select id="app-status-filter" onchange="filterLearnApps()" class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-sm text-gray-900 dark:text-white">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead><tr class="border-b border-gray-100 dark:border-gray-700">
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Package</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Actions</th>
                                </tr></thead>
                                <tbody id="learn-apps-table-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                                    <tr><td colspan="6" class="p-8 text-center text-gray-500"><div class="loader mx-auto mb-3"></div>Loading applications...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Courses overview -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700">
                        <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                            <h2 class="text-lg font-bold text-gray-900 dark:text-white">Course Packages</h2>
                            <p class="text-sm text-gray-500 mt-0.5">Overview of available learn packages</p>
                        </div>
                        <div id="courses-grid" class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-8 text-center text-gray-400"><div class="loader mx-auto mb-3"></div>Loading courses...</div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Code Generator Modal -->
    <div id="code-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-4">
                <div
                    class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                    <i class="fas fa-user-shield text-white text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Referral Code Generator</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Create codes with custom commission rates for KUCCPS groups/institutions</p>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1">Referrer Name *</label>
                    <input type="text" id="admin-ref-name" placeholder="Full Name"
                        class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1">Commission Rate *</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="commission-rate" value="50" min="1" max="100"
                            class="flex-1 px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white font-bold text-center focus:ring-2 focus:ring-primary-500 outline-none">
                        <span class="text-sm font-bold text-gray-700 dark:text-gray-300">%</span>
                    </div>
                </div>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-700 mb-3">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-user-plus text-blue-600 text-sm"></i>
                    <span class="text-xs font-bold text-gray-700 dark:text-gray-300">User Signup Email *</span>
                </div>
                <p class="text-[10px] text-blue-600 dark:text-blue-400 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    User will complete their name, phone, and other details during signup. You only need to provide their email.
                </p>
                <div>
                    <label class="text-[10px] text-gray-500 dark:text-gray-400 mb-1 block">Email Address *</label>
                    <input type="email" id="admin-ref-email" placeholder="user@institution.com"
                        class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 p-3 rounded-lg border border-purple-200 dark:border-purple-700 mb-3">
                <p class="text-[10px] text-gray-500 dark:text-gray-400">
                    <i class="fas fa-info-circle mr-1 text-purple-600"></i>
                    Quick setup: Name, Email & Commission. User adds phone/other details at signup. Earnings rounded up, higher rates for institutions.
                </p>
            </div>
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-700 dark:text-gray-300 mb-1">Referral Code</label>
                <div class="flex gap-2">
                    <input type="text" id="generated-code" readonly
                        class="flex-1 px-3 py-2 bg-gray-100 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-primary-600 dark:text-primary-400 font-mono font-bold text-center text-sm"
                        value="XXXXX">
                    <button onclick="generateAdminReferralCode()" class="px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors text-sm">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <div id="gen-result" class="hidden mb-4 p-3 bg-primary-50 dark:bg-primary-900/20 rounded-lg border border-primary-100 dark:border-primary-800">
                <p class="text-[10px] text-primary-600 dark:text-primary-400 font-bold uppercase mb-2">✓ Referral Code Created Successfully!</p>
                <p class="text-[10px] text-blue-600 dark:text-blue-400 mb-2">
                    <i class="fas fa-arrow-right mr-1"></i>
                    Next: User visits main site → Clicks "Sign Up" → Enters their email → Creates password → Custom commission applies automatically!
                </p>
                <div class="space-y-2">
                    <div class="bg-white dark:bg-gray-700 rounded-lg p-2">
                        <label class="text-[10px] font-semibold text-gray-500 dark:text-gray-400 block mb-1">REFERRAL CODE</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="result-code" readonly class="flex-1 bg-transparent border-none p-0 text-sm font-bold font-mono text-primary-600 dark:text-primary-400 outline-none">
                            <button onclick="copyToClipboard('result-code')" class="px-2 py-1 text-xs bg-primary-500 text-white hover:bg-primary-600 rounded transition-colors">
                                <i class="fas fa-copy mr-1"></i>Copy Code
                            </button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-700 rounded-lg p-2">
                        <label class="text-[10px] font-semibold text-gray-500 dark:text-gray-400 block mb-1">REFERRAL LINK</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="result-link" readonly class="flex-1 bg-transparent border-none p-0 text-xs text-gray-900 dark:text-white outline-none truncate">
                            <button onclick="copyToClipboard('result-link')" class="px-2 py-1 text-xs bg-blue-500 text-white hover:bg-blue-600 rounded transition-colors">
                                <i class="fas fa-link mr-1"></i>Copy Link
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Reload button (shown after auth user creation) -->
                <div id="reload-notice" class="hidden mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-200 dark:border-yellow-800">
                    <p class="text-xs text-yellow-800 dark:text-yellow-300 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>User account created! Reload page to restore your session.
                    </p>
                    <button onclick="location.reload()" class="w-full px-3 py-1.5 text-xs bg-yellow-500 text-white hover:bg-yellow-600 rounded transition-colors font-medium">
                        <i class="fas fa-sync-alt mr-1"></i>Reload Page Now
                    </button>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveAndGenerateAdminCode()" id="save-gen-btn"
                    class="flex-1 bg-gradient-to-r from-primary-500 to-primary-600 text-white py-2.5 rounded-lg text-sm font-bold hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg shadow-primary-500/20">
                    <i class="fas fa-save mr-1"></i>Generate Code
                </button>
                <button onclick="closeCodeGenerator()"
                    class="px-4 py-2.5 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div
                class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
                <div class="flex items-center gap-3">
                    <img src="../assets/images/logo.png" alt="Course Corner" class="w-8 h-8 rounded-lg">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Transaction Details</h3>
                </div>
                <button onclick="closeModal()"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-400"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCt_mM9mwRg0QJpHC4haH7ZsLspVNJI6XM",
            authDomain: "course-corner.firebaseapp.com",
            projectId: "course-corner",
            storageBucket: "course-corner.firebasestorage.app",
            messagingSenderId: "961706784572",
            appId: "1:961706784572:web:7aa6c24946570ffda59039"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // API endpoint - used for M-Pesa re-query operations only
        const API_BASE = 'https://course-corner-server.vercel.app';
        let allTransactions = [], filteredTransactions = [], currentTransactionId = null;
        const db = firebase.firestore();

        // Theme
        function initTheme() {
            const saved = localStorage.getItem('admin-theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('admin-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        initTheme();

        // Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        // Auth
        let isCreatingUser = false; // Flag to prevent redirect during user creation
        
        auth.onAuthStateChanged(user => {
            // Don't redirect if we're in the middle of creating a user account
            if (isCreatingUser) {
                console.log('⏸️ Auth state change blocked - creating referral code in progress');
                return;
            }
            handleAdminAuthState(user, showDashboard);
        });

        function showDashboard(user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            const emailEl = document.getElementById('topbar-email');
            const dropdownEmailEl = document.getElementById('dropdown-email');
            if (emailEl) emailEl.textContent = user.email;
            if (dropdownEmailEl) dropdownEmailEl.textContent = user.email;
            
            // Check for section query
            const urlParams = new URL(window.location.href).searchParams;
            const sectionQuery = urlParams.get('section');
            if (sectionQuery) {
                switchPage(sectionQuery);
            } else {
                loadData();
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            document.getElementById('login-btn-text').textContent = 'Signing in...';
            document.getElementById('login-spinner').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                if (!isAuthorizedAdmin(result.user)) {
                    await auth.signOut();
                    throw { code: 'auth/unauthorized', message: 'Unauthorized: Admin access only.' };
                }
            }
            catch (error) {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-error-message').textContent = getAuthError(error.code);
            } finally {
                btn.disabled = false;
                document.getElementById('login-btn-text').textContent = 'Sign In';
                document.getElementById('login-spinner').classList.add('hidden');
            }
        });

        function getAuthError(code) {
            return {
                'auth/invalid-email': 'Invalid email.',
                'auth/user-not-found': 'No account found.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Invalid credentials.',
                'auth/unauthorized': 'Access denied: Admin only.'
            }[code] || 'Login failed.';
        }
        function logout() { auth.signOut(); }

        // Navigation
        function switchPage(page) {
            // Mapping for shared sections
            const effectivePage = page.startsWith('learn-') ? 'learn' : page;

            ['dashboard','transactions','learn'].forEach(p => {
                const el = document.getElementById(`page-${p}`);
                if (el) el.classList.add('hidden');
            });

            const target = document.getElementById(`page-${effectivePage}`);
            if (target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-600', 'dark:text-primary-400', 'border-primary-500'));
            const nav = document.getElementById(`nav-${page}`);
            if (nav) nav.classList.add('bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-600', 'dark:text-primary-400');
            
            // Sub-nav styling
            if (page.startsWith('learn-')) {
                const parentNav = document.getElementById('nav-learn');
                if (parentNav) parentNav.classList.add('text-primary-600', 'dark:text-primary-400');
                if (nav) nav.classList.add('border-primary-500');
            }

            document.getElementById('page-title').textContent = { 
                dashboard: 'Dashboard', 
                transactions: 'Transactions',
                learn: 'Learn Overview',
                'learn-enrollments': 'Student Enrollments',
                'learn-packages': 'Course Packages'
            }[page] || page;

            document.getElementById('page-subtitle').textContent = { 
                dashboard: 'Overview of your business', 
                transactions: 'All payment records',
                learn: 'Learn Portal Overview',
                'learn-enrollments': 'Manage all student applications',
                'learn-packages': 'Course curriculum & pricing'
            }[page] || '';

            // Scroll to top of table if sub-page
            if (page === 'learn-enrollments') {
                const table = document.getElementById('learn-apps-table-body');
                if (table) table.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (page === 'learn-packages') {
                const grid = document.getElementById('courses-grid');
                if (grid) grid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Load Learn data on first visit
            if (effectivePage === 'learn') {
                if (typeof loadLearnApplications === 'function') loadLearnApplications();
                if (typeof loadLearnCourses === 'function') loadLearnCourses();
            }

            if (window.innerWidth < 1024) toggleSidebar();
        }

        // Data
        async function loadData() { await loadTransactions(); }
        async function loadTransactions() {
            try {
                console.log('📊 [Admin] Loading transactions from Firestore…');

                // Query Firestore directly — no external API dependency
                const snapshot = await db.collection('transactions')
                    .orderBy('createdAt', 'desc')
                    .limit(200)
                    .get()
                    .catch(async (err) => {
                        // If index error, retry without ordering
                        if (err.message && err.message.includes('index')) {
                            console.warn('⚠️ Missing Firestore index, retrying without orderBy');
                            return db.collection('transactions').limit(200).get();
                        }
                        throw err;
                    });

                const raw = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    raw.push({
                        id: doc.id,
                        ...d,
                        createdAt: d.createdAt?.toDate?.() ? d.createdAt.toDate().toISOString() : d.createdAt || null,
                        updatedAt: d.updatedAt?.toDate?.() ? d.updatedAt.toDate().toISOString() : d.updatedAt || null
                    });
                });

                // Exclude Learn portal transactions — they belong to the Learn admin only
                allTransactions = raw.filter(tx => !String(tx.category || '').startsWith('learn-'));

                // Sort newest first (in case we fell back to unordered query)
                allTransactions.sort((a, b) => {
                    const da = a.createdAt ? new Date(a.createdAt) : new Date(0);
                    const db2 = b.createdAt ? new Date(b.createdAt) : new Date(0);
                    return db2 - da;
                });

                filteredTransactions = [...allTransactions];

                console.log(`✅ [Admin] Loaded ${allTransactions.length} transactions (excluded ${raw.length - allTransactions.length} Learn transactions)`);

                // Calculate stats
                const s = { total: 0, completed: 0, pending: 0, failed: 0, completedAmount: 0 };
                allTransactions.forEach(tx => {
                    s.total++;
                    if (tx.status === 'completed') { s.completed++; s.completedAmount += tx.amount || 0; }
                    else if (tx.status === 'pending') { s.pending++; }
                    else if (tx.status === 'failed') { s.failed++; }
                });

                document.getElementById('stat-total').textContent = s.total;
                document.getElementById('stat-completed').textContent = s.completed;
                document.getElementById('stat-failed').textContent = s.failed;
                document.getElementById('stat-revenue').textContent = `KSH ${(s.completedAmount || 0).toLocaleString()}`;
                if (s.total > 0) document.getElementById('stat-completed-pct').textContent = `${Math.round((s.completed / s.total) * 100)}%`;
                renderRecentTransactions();
                renderTransactionsTable();
                updateResultsCount();
            } catch (e) {
                console.error('❌ [Admin] Firestore load error:', e);
                showToast('Error loading transactions: ' + e.message, 'error');
            }
        }

        function renderRecentTransactions() {
            const c = document.getElementById('recent-transactions');
            const r = allTransactions.slice(0, 10);
            if (!r.length) { c.innerHTML = '<div class="p-8 text-center"><i class="fas fa-inbox text-gray-300 dark:text-gray-600 text-4xl mb-3"></i><p class="text-gray-500 dark:text-gray-400">No transactions</p></div>'; return; }
            c.innerHTML = r.map(tx => `
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer" onclick="showDetail('${tx.id}')">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center ${getStatusBg(tx.status)}"><i class="fas ${getStatusIcon(tx.status)} text-lg"></i></div>
                    <div class="flex-1 min-w-0"><p class="font-semibold text-gray-900 dark:text-white">${formatPhone(tx.phoneNumber)}</p><p class="text-sm text-gray-500 dark:text-gray-400">${tx.mpesaReceiptNumber || 'No Receipt'} ${tx.referralCode ? '<span class="text-purple-500">• ' + tx.referralCode + '</span>' : ''}</p></div>
                    <div class="text-right"><p class="font-bold text-gray-900 dark:text-white">KSH ${tx.amount || 0}</p><p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(tx.createdAt)}</p></div>
                </div>`).join('');
        }

        function renderTransactionsTable() {
            const t = document.getElementById('transactions-body');
            const e = document.getElementById('empty-state');
            if (!filteredTransactions.length) { t.innerHTML = ''; e.classList.remove('hidden'); return; }
            e.classList.add('hidden');
            t.innerHTML = filteredTransactions.map(tx => `
                <tr class="table-row">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="tx-checkbox w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500" value="${tx.id}" onchange="updateBulkActions()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">${formatDate(tx.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">${formatPhone(tx.phoneNumber)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900 dark:text-white">KSH ${tx.amount || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 rounded-full text-xs font-medium ${getPackageBadge(tx.category)}">${formatCategory(tx.category)}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(tx.status)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono text-sm font-bold ${tx.mpesaReceiptNumber ? 'text-primary-600 dark:text-primary-400' : 'text-gray-400'}">${tx.mpesaReceiptNumber || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono text-sm ${tx.referralCode ? 'text-purple-600 dark:text-purple-400 font-bold' : 'text-gray-400'}">${tx.referralCode || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <button onclick="showDetail('${tx.id}')" class="p-2 text-gray-400 hover:text-primary-600 dark:hover:text-primary-400"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteTransaction('${tx.id}')" class="p-2 text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`).join('');
            document.getElementById('select-all-transactions').checked = false;
            updateBulkActions();
        }

        function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-KE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'; }
        function formatPhone(p) { if (!p) return '-'; const str = String(p); return str.replace(/(\d{3})(\d{3})(\d{3})(\d{3})/, '$1 $2 $3 $4'); }
        function formatCategory(c) {
            return {
                'calculate-cluster-points': 'Starter',
                'courses-only': 'Standard',
                'point-and-courses': 'Premium',
                'bronze': 'Bronze',
                'silver': 'Silver',
                'gold': 'Gold'
            }[c] || c || 'Standard';
        }
        function getPackageBadge(c) {
            return {
                'calculate-cluster-points': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                'courses-only': 'bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-400',
                'point-and-courses': 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400',
                'bronze': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400',
                'silver': 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200',
                'gold': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'
            }[c] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        }
        function getStatusBadge(s) { return { 'completed': '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"><i class="fas fa-check-circle"></i>Completed</span>', 'pending': '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400"><i class="fas fa-clock"></i>Pending</span>', 'failed': '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"><i class="fas fa-times-circle"></i>Failed</span>' }[s] || `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100">${s}</span>`; }
        function getStatusBg(s) { return { 'completed': 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400', 'pending': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400', 'failed': 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400' }[s] || 'bg-gray-100'; }
        function getStatusIcon(s) { return { 'completed': 'fa-check', 'pending': 'fa-clock', 'failed': 'fa-times' }[s] || 'fa-receipt'; }

        function getMpesaIssueInfo(tx) {
            const status = (tx.status || '').toLowerCase();
            const descRaw = tx.resultDesc || '';
            const desc = descRaw.toLowerCase();
            const code = tx.resultCode != null ? String(tx.resultCode) : '';

            if (status === 'completed') return null;

            const info = { severity: status === 'failed' ? 'error' : 'warning', title: '', detail: '', suggestion: '', code: code || null };

            if (status === 'pending') {
                info.title = 'Pending — awaiting customer action';
                info.detail = descRaw || 'No callback received yet. This usually means the customer did not complete the prompt on their phone.';
                info.suggestion = 'Ask the customer to check their phone and enter the M-Pesa PIN. If they already paid, click “Re-query”.';

                if (desc.includes('processing')) {
                    info.title = 'Pending — still processing';
                    info.suggestion = 'Wait a moment then click “Re-query”.';
                }
                return info;
            }

            // Failed - categorize common M-Pesa failures
            if (desc.includes('wrong pin') || desc.includes('incorrect pin') || desc.includes('pin')) {
                info.title = 'Failed — wrong PIN';
                info.suggestion = 'Customer should retry and enter the correct M-Pesa PIN.';
            } else if (desc.includes('insufficient') || desc.includes('balance is insufficient') || desc.includes('low balance')) {
                info.title = 'Failed — insufficient balance';
                info.suggestion = 'Customer should top up then retry the payment.';
            } else if (desc.includes('timeout') || desc.includes('timed out') || desc.includes('time out')) {
                info.title = 'Failed — timeout';
                info.suggestion = 'Customer should retry; ensure phone has network and is unlocked.';
            } else if (desc.includes('cancel') || desc.includes('cancelled') || desc.includes('canceled')) {
                info.title = 'Failed — cancelled by user';
                info.suggestion = 'Customer should initiate payment again and complete the prompt.';
            } else if (desc.includes('unable to lock subscriber') || desc.includes('another transaction is in process') || desc.includes('in process')) {
                info.title = 'Failed — phone busy / another transaction running';
                info.suggestion = 'Wait 1–2 minutes and retry when the phone is free.';
            } else if (desc.includes('invalid amount') || desc.includes('amount is invalid')) {
                info.title = 'Failed — invalid amount';
                info.suggestion = 'Confirm the amount sent to M-Pesa matches the selected package.';
            } else {
                info.title = 'Failed — payment not completed';
                info.suggestion = 'Click “Re-query” to refresh, or ask customer to retry.';
            }

            info.detail = descRaw || (code ? `Failed with code: ${code}` : 'Payment failed.');
            return info;
        }

        function renderMpesaIssueBlock(tx) {
            const info = getMpesaIssueInfo(tx);
            if (!info) return '';

            const colors = info.severity === 'error'
                ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'
                : 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800';

            const titleColor = info.severity === 'error' ? 'text-red-700 dark:text-red-300' : 'text-yellow-700 dark:text-yellow-300';
            const codeHtml = info.code ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Result code: <span class="font-mono font-semibold">${info.code}</span></p>` : '';

            return `
                <div class="p-4 rounded-xl ${colors}">
                    <p class="text-sm font-bold ${titleColor}">${info.title}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${info.detail}</p>
                    ${codeHtml}
                    ${info.suggestion ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-2"><i class="fas fa-lightbulb mr-2"></i>${info.suggestion}</p>` : ''}
                </div>
            `;
        }

        // Filters
        function handleSearch() { applyAllFilters(); }
        function applyAllFilters() {
            const search = document.getElementById('search-input').value.toLowerCase().trim();
            const status = document.getElementById('status-filter').value;
            const category = document.getElementById('category-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            filteredTransactions = allTransactions.filter(tx => {
                const searchStr = search.toLowerCase();
                const phoneStr = tx.phoneNumber ? String(tx.phoneNumber).toLowerCase() : '';
                const mpesaCode = tx.mpesaReceiptNumber ? String(tx.mpesaReceiptNumber).toLowerCase() : '';
                const refCode = tx.referralCode ? String(tx.referralCode).toLowerCase() : '';
                const txId = tx.id ? String(tx.id).toLowerCase() : '';
                
                if (search && !(
                    phoneStr.includes(searchStr) || 
                    mpesaCode.includes(searchStr) || 
                    refCode.includes(searchStr) || 
                    txId.includes(searchStr)
                )) return false;
                
                if (status && tx.status !== status) return false;
                if (category && tx.category !== category) return false;
                if (dateFrom && new Date(tx.createdAt) < new Date(dateFrom)) return false;
                if (dateTo && new Date(tx.createdAt) > new Date(dateTo + 'T23:59:59')) return false;
                return true;
            });
            renderTransactionsTable();
            updateResultsCount();
        }
        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            filteredTransactions = [...allTransactions];
            renderTransactionsTable();
            updateResultsCount();
        }
        function updateResultsCount() { document.getElementById('results-count').textContent = `${filteredTransactions.length} of ${allTransactions.length}`; }

        // Modals
        function showDetail(id, opts = {}) {
            const tx = allTransactions.find(t => t.id === id);
            if (!tx) return;
            currentTransactionId = id;
            const showRequeryBtn = (tx.status === 'completed' && !tx.mpesaReceiptNumber) || tx.status === 'pending' || tx.status === 'failed';
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center gap-4 p-4 rounded-2xl ${getStatusBg(tx.status)}">
                        <div class="w-14 h-14 rounded-xl bg-white/50 dark:bg-black/20 flex items-center justify-center"><i class="fas ${getStatusIcon(tx.status)} text-2xl"></i></div>
                        <div><p class="text-sm opacity-75">Status</p><p class="text-xl font-bold capitalize">${tx.status}</p></div>
                        ${showRequeryBtn ? `<button onclick="requeryTransaction('${tx.id}')" class="ml-auto px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium"><i class="fas fa-sync-alt mr-1"></i>Re-query</button>` : ''}
                    </div>
                    ${showRequeryBtn ? `<div id="auto-requery-hint" class="text-xs text-gray-500 dark:text-gray-400">Tip: Pending/No receipt? We can check M-Pesa for the latest status.</div>` : ''}
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Phone</p><p class="font-semibold text-gray-900 dark:text-white">${formatPhone(tx.phoneNumber)}</p></div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Amount</p><p class="font-bold text-2xl text-primary-600 dark:text-primary-400">KSH ${tx.amount || 0}</p></div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Package</p><p class="font-semibold text-gray-900 dark:text-white">${formatCategory(tx.category)}</p></div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">M-Pesa Code</p><p class="font-mono font-bold ${tx.mpesaReceiptNumber ? 'text-primary-600 dark:text-primary-400' : 'text-gray-400'}">${tx.mpesaReceiptNumber || 'Not captured'}</p></div>
                    </div>
                    ${tx.referralCode ? `<div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800"><p class="text-xs text-purple-600 dark:text-purple-400 mb-1">Referral Code</p><p class="font-mono font-bold text-purple-700 dark:text-purple-300">${tx.referralCode}</p></div>` : ''}
                    ${renderMpesaIssueBlock(tx)}
                    ${tx.resultDesc ? `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Result</p><p class="text-sm text-gray-700 dark:text-gray-300">${tx.resultDesc}</p></div>` : ''}
                    <div class="text-sm text-gray-500 dark:text-gray-400"><i class="fas fa-calendar mr-2"></i>${formatDate(tx.createdAt)}</div>
                </div>`;
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');

            if (!opts.skipAutoRequery && showRequeryBtn) {
                autoRequeryForDetail(id);
            }
        }

        async function autoRequeryForDetail(transactionId) {
            const hintEl = document.getElementById('auto-requery-hint');
            if (!hintEl) return;
            hintEl.textContent = 'Checking M-Pesa status...';
            try {
                const res = await fetch(`${API_BASE}/api/mpesa/admin/requery/${transactionId}`, { method: 'POST' });
                const data = await res.json();

                if (data.success && data.updated) {
                    hintEl.textContent = 'Updated from M-Pesa. Refreshing details...';
                    await loadTransactions();
                    showDetail(transactionId, { skipAutoRequery: true });
                    return;
                }

                hintEl.textContent = data.success ? 'No updates available from M-Pesa yet.' : ('Re-query failed: ' + (data.message || 'Unknown error'));
            } catch (e) {
                hintEl.textContent = 'Re-query error: ' + (e.message || e);
            }
        }
        function closeModal() { document.getElementById('detail-modal').classList.add('hidden'); document.getElementById('detail-modal').classList.remove('flex'); }

        // Code Generator - Admin can generate UNLIMITED codes, all stored permanently
        let generatedCodes = JSON.parse(localStorage.getItem('adminCodes') || '[]');
        let currentAdminCode = null; // Store the admin's existing code

        async function checkAdminExistingCode() {
            try {
                const user = auth.currentUser;
                if (!user || !user.email) return null;

                // Check if logged-in admin has a referral code already
                const snapshot = await db.collection('referralCodes')
                    .where('userEmail', '==', user.email)
                    .limit(1)
                    .get();

                if (!snapshot.empty) {
                    const codeData = snapshot.docs[0].data();
                    console.log('✅ Found existing code for admin:', codeData.code);
                    return codeData;
                }
                return null;
            } catch (error) {
                console.error('Error checking existing code:', error);
                return null;
            }
        }

        async function openCodeGenerator() {
            // Check if admin already has a code
            const existingCode = await checkAdminExistingCode();
            
            if (existingCode) {
                // Pre-fill form with existing data
                document.getElementById('admin-ref-name').value = existingCode.userName || existingCode.displayName || '';
                document.getElementById('admin-ref-email').value = existingCode.userEmail || '';
                document.getElementById('commission-rate').value = existingCode.commissionRate || 50;
                document.getElementById('generated-code').value = existingCode.code;
                
                // Show the result section with the existing code
                const link = 'https://coursecornerkenya.com/#ref=' + existingCode.code;
                document.getElementById('result-code').value = existingCode.code;
                document.getElementById('result-link').value = link;
                document.getElementById('gen-result').classList.remove('hidden');
                
                showToast('✅ Your existing referral code is displayed below', 'info', 4000);
            } else {
                // Reset form for new code
                document.getElementById('admin-ref-name').value = '';
                document.getElementById('admin-ref-email').value = auth.currentUser?.email || '';
                document.getElementById('commission-rate').value = '50';
                document.getElementById('generated-code').value = 'XXXXX';
                document.getElementById('gen-result').classList.add('hidden');
            }
            
            document.getElementById('reload-notice').classList.add('hidden');
            document.getElementById('code-modal').classList.remove('hidden');
            document.getElementById('code-modal').classList.add('flex');
        }
        function closeCodeGenerator() { 
            document.getElementById('code-modal').classList.add('hidden'); 
            document.getElementById('code-modal').classList.remove('flex'); 
            document.getElementById('gen-result').classList.add('hidden');
            document.getElementById('reload-notice').classList.add('hidden');
        }

        function generateAdminReferralCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('generated-code').value = code;
            return code;
        }

        async function saveAndGenerateAdminCode() {
            const name = document.getElementById('admin-ref-name').value.trim();
            const email = document.getElementById('admin-ref-email').value.trim();
            let code = document.getElementById('generated-code').value;
            const currentAdmin = auth.currentUser; // Get admin info before any auth operations

            if (!name) {
                showToast('Please enter referrer name', 'warning');
                return;
            }

            if (!email) {
                showToast('Email is required - it links the code to the institutional account', 'warning');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'warning');
                return;
            }

            if (code === 'XXXXX') {
                code = generateAdminReferralCode();
            }

            // Get commission rate
            const commissionRate = parseInt(document.getElementById('commission-rate').value) || 50;
            if (!commissionRate || commissionRate < 1 || commissionRate > 100) {
                showToast('Please enter a valid commission rate (1-100%)', 'error');
                return;
            }

            const btn = document.getElementById('save-gen-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            // IMPORTANT: Set flag to prevent auth state changes from logging us out
            isCreatingUser = true;
            console.log('🔒 Admin session protected - creating referral code...');

            try {

                // Don't create Firebase Auth account here - it logs out the admin!
                // Auth account will be created when user first logs in on the main site
                
                // Check if user already exists (update their commission if they do)
                let authUserId = null;
                
                // Search by email first
                if (email) {
                    try {
                        const usersSnapshot = await db.collection('users').where('email', '==', email).limit(1).get();
                        if (!usersSnapshot.empty) {
                            authUserId = usersSnapshot.docs[0].id;
                            console.log('✅ Found existing user by email:', authUserId);
                        }
                    } catch (e) {
                        console.warn('Could not check for existing user by email:', e);
                    }
                }
                
                // Search by referral code (in case they're being reassigned)
                if (!authUserId) {
                    try {
                        const usersSnapshot = await db.collection('users').where('referralCode', '==', code).limit(1).get();
                        if (!usersSnapshot.empty) {
                            authUserId = usersSnapshot.docs[0].id;
                            console.log('✅ Found existing user by referral code:', authUserId);
                        }
                    } catch (e) {
                        console.warn('Could not check for existing user by code:', e);
                    }
                }
                
                // Save to referralCodes collection with signup email (required)
                await db.collection('referralCodes').doc(code).set({
                    code: code,
                    userId: authUserId || 'pending', // Will be set when user signs up
                    userEmail: email,
                    userName: name,
                    displayName: name,
                    phoneNumber: '', // User will provide during signup
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    totalReferrals: 0,
                    paidReferrals: 0,
                    totalEarnings: 0,
                    pendingPayout: 0,
                    isActive: true,
                    isAdminCode: true,
                    commissionRate: commissionRate,
                    accountType: 'institutional',
                    createdBy: 'admin',
                    createdByAdmin: currentAdmin?.email || 'admin',
                    isAdminGenerated: true,
                    source: 'admin-manual',
                    pendingAuth: !authUserId, // True if user needs to signup on main site
                    setupEmail: email // Required - used for auto-detection during signup
                });

                // Update existing user's profile with new commission rate
                if (authUserId) {
                    // User exists, update their profile with new code and custom commission
                    await db.collection('users').doc(authUserId).update({
                        referralCode: code,
                        email: email || firebase.firestore.FieldValue.delete(),
                        phoneNumber: '', // Phone will be provided by user during signup
                        displayName: name,
                        isAdmin: true,
                        commissionRate: commissionRate, // THIS IS KEY - updated commission rate
                        accountType: 'institutional',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log(`✅ Updated existing user ${authUserId} with ${commissionRate}% commission`);
                    showToast(`Updated existing user with ${commissionRate}% commission`, 'info', 3000);
                } else {
                    // PHASE 1: User will SIGN UP on main site (not pre-create Auth account)
                    // The signup flow auto-detects setupEmail in referralCodes and applies institutional settings
                    // PHASE 2: Will use backend API to pre-create Auth account for direct login
                    console.log(`📝 Code saved. User will SIGN UP on main site with ${email || 'their email'}`);
                }

                // Show results
                const link = 'https://coursecornerkenya.com/#ref=' + code;
                document.getElementById('result-code').value = code;
                document.getElementById('result-link').value = link;
                document.getElementById('gen-result').classList.remove('hidden');
                document.getElementById('reload-notice').classList.add('hidden');

                const message = `✅ Code ready! User should SIGN UP on main site using ${email} (they'll create their own password)`;
                showToast(message, 'success', 5000);
                
                // Add to local history
                if (!generatedCodes.includes(code)) {
                    generatedCodes.unshift(code);
                    localStorage.setItem('adminCodes', JSON.stringify(generatedCodes));
                }
            } catch (error) {
                console.error('Error saving code:', error);
                showToast('Failed to save code: ' + error.message, 'error');
            } finally {
                // IMPORTANT: Reset flag to allow normal auth state changes
                isCreatingUser = false;
                console.log('🔓 Admin session protection released');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-1"></i>Generate Code';
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (!element || !element.value) {
                showToast('Nothing to copy', 'warning');
                return;
            }
            navigator.clipboard.writeText(element.value).then(() => {
                const isCode = elementId.includes('code');
                showToast((isCode ? 'Code' : 'Link') + ' copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy', 'error');
            });
        }

        function copyGeneratedCode() {
            const code = document.getElementById('generated-code').value;
            if (!code || code === 'XXXXX') { showToast('Generate first', 'warning'); return; }
            navigator.clipboard.writeText('https://coursecornerkenya.com/#ref=' + code).then(() => showToast('Link copied!', 'success'));
        }
        function updateCodesHistory() {
            const c = document.getElementById('codes-history'), l = document.getElementById('codes-list');
            if (!generatedCodes.length) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden');
            l.innerHTML = generatedCodes.map(code => `<span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm font-mono cursor-pointer hover:bg-primary-100 dark:hover:bg-primary-900/30" onclick="selectCode('${code}')">${code}</span>`).join('');
        }
        function selectCode(code) { document.getElementById('generated-code').value = code; copyGeneratedCode(); }

        // Magic Link Generator
        function openMagicLinkGenerator() {
            Swal.fire({
                title: '🔗 Generate Magic Link',
                html: `
                    <div style="text-align: left; padding: 1rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                                <i class="fas fa-clock text-amber-500"></i> Link Expires In (minutes)
                            </label>
                            <input type="number" id="magic-expiry" value="10" min="1" max="60" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem;">
                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Link will auto-expire after this duration
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151;">
                                <i class="fas fa-hashtag text-amber-500"></i> Maximum Uses
                            </label>
                            <input type="number" id="magic-uses" value="5" min="1" max="100" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem;">
                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                <i class="fas fa-info-circle"></i> Link will stop working after this many uses
                            </p>
                        </div>

                        <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 0.75rem; padding: 1rem; margin-top: 1rem;">
                            <p style="font-size: 0.875rem; color: #92400e; margin: 0; line-height: 1.5;">
                                <i class="fas fa-shield-alt"></i> <strong>Magic Link Bypass:</strong><br>
                                Users with this link can view their results without payment. Use responsibly!
                            </p>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-magic"></i> Generate Link',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                width: '600px',
                preConfirm: async () => {
                    const expiry = parseInt(document.getElementById('magic-expiry').value);
                    const maxUses = parseInt(document.getElementById('magic-uses').value);

                    if (expiry < 1 || expiry > 60) {
                        Swal.showValidationMessage('Expiry must be between 1-60 minutes');
                        return false;
                    }
                    if (maxUses < 1 || maxUses > 100) {
                        Swal.showValidationMessage('Max uses must be between 1-100');
                        return false;
                    }

                    return { expiry, maxUses };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await generateMagicLink(result.value.expiry, result.value.maxUses);
                }
            });
        }

        async function generateMagicLink(expiryMinutes, maxUses) {
            showToast('Generating magic link...', 'info');
            
            try {
                // Generate unique token
                const token = generateRandomToken(32);
                const expiresAt = new Date(Date.now() + expiryMinutes * 60 * 1000);

                // Save to Firestore
                await db.collection('magicTokens').doc(token).set({
                    token: token,
                    expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
                    maxUses: maxUses,
                    usedCount: 0,
                    createdBy: auth.currentUser?.email || 'admin',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true
                });

                // Generate the magic link
                const magicLink = `https://coursecornerkenya.com/pages/calculator.html?magic=${token}`;

                // Show success with copy option
                Swal.fire({
                    icon: 'success',
                    title: '✨ Magic Link Generated!',
                    html: `
                        <div style="text-align: left; padding: 1rem;">
                            <div style="background: #f3f4f6; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                                <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 600;">MAGIC LINK</p>
                                <input type="text" readonly value="${magicLink}" id="magic-link-display"
                                    style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; background: white;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem;">
                                    <p style="font-size: 0.75rem; color: #92400e; margin: 0;">⏱️ Expires in</p>
                                    <p style="font-size: 1.25rem; font-weight: 700; color: #b45309; margin: 0;">${expiryMinutes} min</p>
                                </div>
                                <div style="background: #dbeafe; padding: 0.75rem; border-radius: 0.5rem;">
                                    <p style="font-size: 0.75rem; color: #1e40af; margin: 0;">🔢 Max Uses</p>
                                    <p style="font-size: 1.25rem; font-weight: 700; color: #1d4ed8; margin: 0;">${maxUses}</p>
                                </div>
                            </div>

                            <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.75rem; padding: 0.75rem;">
                                <p style="font-size: 0.75rem; color: #991b1b; margin: 0; line-height: 1.5;">
                                    <i class="fas fa-exclamation-triangle"></i> This link bypasses payment verification. Share only with authorized users.
                                </p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '<i class="fas fa-copy"></i> Copy Link',
                    confirmButtonColor: '#10b981',
                    didOpen: () => {
                        document.getElementById('magic-link-display').select();
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        navigator.clipboard.writeText(magicLink);
                        showToast('Link copied to clipboard!', 'success');
                    }
                });

            } catch (error) {
                console.error('Error generating magic link:', error);
                showToast('Failed to generate link: ' + error.message, 'error');
            }
        }

        function generateRandomToken(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < length; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        }

        // Actions
        async function requeryTransaction(transactionId) {
            showToast('Re-querying M-Pesa...', 'info');
            try {
                const res = await fetch(`${API_BASE}/api/mpesa/admin/requery/${transactionId}`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    if (data.updated) {
                        showToast('Transaction updated!', 'success');
                        await loadTransactions();
                    } else {
                        showToast('No updates available', 'warning');
                    }
                    console.log('Requery result:', data);
                } else {
                    showToast('Requery failed: ' + data.message, 'error');
                }
            } catch (e) {
                console.error('Requery error:', e);
                showToast('Requery error: ' + e.message, 'error');
            }
        }

        function refreshData() { loadData(); showToast('Refreshed', 'success'); }
        function exportToCSV() {
            if (!filteredTransactions.length) { showToast('No data', 'warning'); return; }
            let csv = 'Date,Phone,Amount,Package,Status,M-Pesa\n';
            filteredTransactions.forEach(tx => { csv += `"${formatDate(tx.createdAt)}","${tx.phoneNumber}","${tx.amount}","${formatCategory(tx.category)}","${tx.status}","${tx.mpesaReceiptNumber || ''}"\n`; });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            link.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('CSV exported', 'success');
        }
        function exportToPDF() {
            if (!filteredTransactions.length) { showToast('No data', 'warning'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.setTextColor(22, 163, 74);
            doc.text('Course Corner - Transactions', 14, 22);
            doc.autoTable({ startY: 35, head: [['Date', 'Phone', 'Amount', 'Package', 'Status', 'M-Pesa']], body: filteredTransactions.map(tx => [formatDate(tx.createdAt), tx.phoneNumber || '-', `KSH ${tx.amount || 0}`, formatCategory(tx.category), tx.status, tx.mpesaReceiptNumber || '-']), theme: 'striped', headStyles: { fillColor: [22, 163, 74] } });
            doc.save(`transactions_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF generated', 'success');
        }

        // Selection & Delete
        function toggleSelectAllTransactions() {
            const checked = document.getElementById('select-all-transactions').checked;
            document.querySelectorAll('.tx-checkbox').forEach(cb => cb.checked = checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.tx-checkbox:checked');
            const bar = document.getElementById('bulk-actions');
            const count = document.getElementById('selected-count');
            if (selected.length > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selected.length} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction? This cannot be undone.')) return;
            try {
                await db.collection('transactions').doc(id).delete();
                showToast('Transaction deleted', 'success');
                loadTransactions();
            } catch (e) {
                console.error(e);
                showToast('Error deleting transaction', 'error');
            }
        }

        async function deleteSelectedTransactions() {
            const selected = Array.from(document.querySelectorAll('.tx-checkbox:checked')).map(cb => cb.value);
            if (!selected.length) return;
            if (!confirm(`Are you sure you want to delete ${selected.length} transactions? This cannot be undone.`)) return;

            showToast(`Deleting ${selected.length} items...`, 'info');
            try {
                const batch = db.batch();
                selected.forEach(id => {
                    batch.delete(db.collection('transactions').doc(id));
                });
                await batch.commit();
                showToast(`Successfully deleted ${selected.length} items`, 'success');
                loadTransactions();
            } catch (e) {
                console.error(e);
                showToast('Error in bulk delete', 'error');
            }
        }

        // Toast
        function showToast(msg, type = 'info', duration = 3000) {
            const c = document.getElementById('toast-container');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const t = document.createElement('div');
            t.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 animate-slide-in`;
            t.innerHTML = `<i class="fas ${icons[type]}"></i><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), duration);
        }

        // Init
        const urlParams = new URLSearchParams(window.location.search);
        const startPage = urlParams.get('page') || 'dashboard';
        switchPage(startPage);

        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); closeCodeGenerator(); } });
        document.getElementById('detail-modal').addEventListener('click', function (e) { if (e.target === this) closeModal(); });
        document.getElementById('code-modal').addEventListener('click', function (e) { if (e.target === this) closeCodeGenerator(); });
    </script>
</body>

</html>