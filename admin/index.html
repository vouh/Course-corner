<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Course Corner</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="icon" href="../favicon.ico" sizes="any">
    <link rel="manifest" href="../site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="js/admin-auth.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
                            400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
                            800: '#166534', 900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #374151;
            border-top-color: #22c55e;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .stat-gradient-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-gradient-2 {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .stat-gradient-3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-gradient-4 {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .table-row:hover {
            background: rgba(34, 197, 94, 0.05);
        }

        .dark .table-row:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .sidebar {
            transition: transform 0.3s ease, width 0.3s ease;
        }

        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
        }

        .dark .hover-lift:hover {
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.4);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slide-in 0.3s ease;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-2 sm:p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-4 sm:mb-8">
                <img src="../assets/images/logo.png" alt="Course Corner"
                    class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-3 sm:mb-4 rounded-2xl shadow-lg">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Course Corner</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1 sm:mt-2 text-sm sm:text-base">Admin Dashboard</p>
            </div>

            <div
                class="bg-white dark:bg-gray-800 rounded-2xl sm:rounded-3xl shadow-xl p-4 sm:p-8 border border-gray-100 dark:border-gray-700">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4 sm:mb-6">Welcome back</h2>

                <form id="login-form" class="space-y-3 sm:space-y-5">
                    <div>
                        <label
                            class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 sm:mb-2">
                            <i class="fas fa-envelope mr-2 text-primary-500"></i>Email Address
                        </label>
                        <input type="email" id="login-email" required
                            class="w-full px-3 sm:px-4 py-3 sm:py-4 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg sm:rounded-xl text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm sm:text-base"
                            placeholder="admin@coursecorner.com">
                    </div>

                    <div>
                        <label
                            class="block text-xs sm:text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 sm:mb-2">
                            <i class="fas fa-lock mr-2 text-primary-500"></i>Password
                        </label>
                        <input type="password" id="login-password" required
                            class="w-full px-3 sm:px-4 py-3 sm:py-4 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg sm:rounded-xl text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-sm sm:text-base"
                            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>

                    <div id="login-error"
                        class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-xl text-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="login-error-message"></span>
                    </div>

                    <button type="submit" id="login-btn"
                        class="w-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white py-3 sm:py-4 rounded-lg sm:rounded-xl font-bold text-base sm:text-lg shadow-lg shadow-primary-500/30 hover:shadow-primary-500/50 transition-all flex items-center justify-center gap-2">
                        <span id="login-btn-text">Sign In</span>
                        <i id="login-spinner" class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </form>

                <div
                    class="mt-4 sm:mt-6 pt-4 sm:pt-6 border-t border-gray-100 dark:border-gray-700 flex items-center justify-center gap-4">
                    <span class="text-sm text-gray-500 dark:text-gray-400">Theme:</span>
                    <button onclick="toggleTheme()"
                        class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-sun dark:hidden"></i>
                        <i class="fas fa-moon hidden dark:inline"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed left-0 top-0 h-full w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-40 sidebar -translate-x-full lg:translate-x-0">
            <div class="h-20 flex items-center gap-3 px-6 border-b border-gray-200 dark:border-gray-700">
                <img src="../assets/images/logo.png" alt="Course Corner" class="w-12 h-12 rounded-xl shadow-lg">
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Course Corner</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Admin Panel</p>
                </div>
            </div>

            <nav class="p-4 space-y-2">
                <a href="#" onclick="switchPage('dashboard')" id="nav-dashboard"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-chart-pie text-xl w-6"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" onclick="switchPage('transactions')" id="nav-transactions"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-receipt text-xl w-6"></i>
                    <span>Transactions</span>
                </a>
                <a href="referrals.html" id="nav-referrals"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-users text-xl w-6"></i>
                    <span>Referrals</span>
                </a>
                <a href="withdrawals.html" id="nav-withdrawals"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-money-bill-wave text-xl w-6"></i>
                    <span>Withdrawals</span>
                </a>

                <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <p
                        class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2">
                        Tools</p>
                    <a href="referral-codes.html"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-ticket-alt text-xl w-6"></i>
                        <span>All Referral Codes</span>
                    </a>
                    <a href="#" onclick="openCodeGenerator()"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-gift text-xl w-6"></i>
                        <span>Code Generator</span>
                    </a>
                </div>
            </nav>

            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebar-email" class="text-sm font-medium text-gray-900 dark:text-white truncate">
                            admin@email.com</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Administrator</p>
                    </div>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-red-500 transition-colors"
                        title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:ml-72 min-h-screen">
            <!-- Top Bar -->
            <header
                class="h-20 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30 px-4 lg:px-8 flex items-center justify-between">
                <button onclick="toggleSidebar()"
                    class="lg:hidden p-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <div class="hidden lg:block">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h2>
                    <p id="page-subtitle" class="text-sm text-gray-500 dark:text-gray-400">Overview of your business</p>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="refreshData()"
                        class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Refresh">
                        <i class="fas fa-sync-alt text-lg"></i>
                    </button>
                    <button onclick="toggleTheme()"
                        class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Toggle Theme">
                        <i class="fas fa-sun text-lg dark:hidden"></i>
                        <i class="fas fa-moon text-lg hidden dark:inline"></i>
                    </button>
                    <div class="hidden sm:flex items-center gap-3 pl-3 border-l border-gray-200 dark:border-gray-700">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                </div>
            </header>

            <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden">
            </div>

            <main class="p-4 lg:p-8">
                <!-- Dashboard Page -->
                <div id="page-dashboard">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 stat-gradient-1 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-receipt text-white text-2xl"></i>
                                </div>
                                <span
                                    class="text-xs font-medium text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-lg">All
                                    Time</span>
                            </div>
                            <p id="stat-total" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Transactions</p>
                        </div>

                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 stat-gradient-2 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-check-circle text-white text-2xl"></i>
                                </div>
                                <span class="flex items-center gap-1 text-green-500 text-sm font-medium">
                                    <i class="fas fa-arrow-up text-xs"></i>
                                    <span id="stat-completed-pct">0%</span>
                                </span>
                            </div>
                            <p id="stat-completed" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Completed</p>
                        </div>

                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 stat-gradient-4 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-times-circle text-white text-2xl"></i>
                                </div>
                                <span class="relative flex h-3 w-3">
                                    <span
                                        class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                                </span>
                            </div>
                            <p id="stat-failed" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Failed</p>
                        </div>

                        <div
                            class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <div
                                    class="w-14 h-14 bg-gradient-to-br from-emerald-400 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-coins text-white text-2xl"></i>
                                </div>
                                <span
                                    class="text-xs font-medium text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded-lg">Revenue</span>
                            </div>
                            <p id="stat-revenue" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                            <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Revenue</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <button onclick="syncFailedTransactions()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-red-500 dark:hover:border-red-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-sync-alt text-red-600 dark:text-red-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Sync Failed</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Fix Statuses</p>
                            </div>
                        </button>



                        <button onclick="exportToCSV()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-file-csv text-blue-600 dark:text-blue-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Export</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Download CSV</p>
                            </div>
                        </button>

                        <button onclick="exportToPDF()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-file-pdf text-red-600 dark:text-red-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Report</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Generate PDF</p>
                            </div>
                        </button>

                        <button onclick="openCodeGenerator()"
                            class="flex items-center gap-4 p-4 bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all group">
                            <div
                                class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="fas fa-magic text-purple-600 dark:text-purple-400 text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900 dark:text-white">Generate</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Referral Code</p>
                            </div>
                        </button>


                    </div>

                    <!-- Recent Transactions -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div
                            class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Recent Transactions</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Latest payment activities</p>
                            </div>
                            <a href="#" onclick="switchPage('transactions')"
                                class="text-primary-600 hover:text-primary-700 dark:text-primary-400 font-medium text-sm">
                                View All <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                        <div id="recent-transactions" class="divide-y divide-gray-100 dark:divide-gray-700">
                            <div class="p-8 text-center">
                                <div class="loader mx-auto mb-4"></div>
                                <p class="text-gray-500 dark:text-gray-400">Loading transactions...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Page -->
                <div id="page-transactions" class="hidden">
                    <div
                        class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2 flex gap-2">
                                <div class="relative flex-1">
                                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="search-input" placeholder="Search phone, M-Pesa code, or ID..."
                                        class="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white"
                                        onkeyup="handleSearch()">
                                </div>
                                <button onclick="handleSearch()" class="px-5 bg-primary-500 hover:bg-primary-600 text-white rounded-xl transition-all shadow-lg shadow-primary-500/20">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <div id="bulk-actions"
                                    class="hidden flex items-center gap-2 px-4 py-1 bg-primary-50 dark:bg-primary-900/20 border border-primary-100 dark:border-primary-800 rounded-xl animate-slide-in">
                                    <span id="selected-count"
                                        class="text-sm font-bold text-primary-700 dark:text-primary-300">0</span>
                                    <button onclick="deleteSelectedTransactions()"
                                        class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                                        title="Delete Selected">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <select id="status-filter" onchange="applyAllFilters()"
                                    class="px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <select id="category-filter" onchange="applyAllFilters()"
                                class="px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                                <option value="">All Packages</option>
                                <option value="calculate-cluster-points">Starter</option>
                                <option value="courses-only">Standard</option>
                                <option value="point-and-courses">Premium</option>
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold">Gold</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">From
                                    Date</label>
                                <input type="date" id="date-from" onchange="applyAllFilters()"
                                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">To
                                    Date</label>
                                <input type="date" id="date-to" onchange="applyAllFilters()"
                                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white">
                            </div>
                            <div class="flex items-end">
                                <button onclick="clearAllFilters()"
                                    class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-times mr-2"></i>Clear
                                </button>
                            </div>
                            <div class="flex items-end">
                                <div class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-xl text-center">
                                    <span id="results-count" class="text-sm text-gray-600 dark:text-gray-300">0
                                        results</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 dark:bg-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-4 text-left">
                                            <input type="checkbox" id="select-all-transactions"
                                                onchange="toggleSelectAllTransactions()"
                                                class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                        </th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Date</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Phone</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Amount</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Package</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Status</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            M-Pesa Code</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Referral</th>
                                        <th
                                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                            Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                                    <tr>
                                        <td colspan="9" class="px-6 py-12 text-center">
                                            <div class="loader mx-auto mb-4"></div>
                                            <p class="text-gray-500 dark:text-gray-400">Loading...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="empty-state" class="hidden p-12 text-center">
                            <div
                                class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-inbox text-gray-400 text-3xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Transactions Found
                            </h3>
                            <p class="text-gray-500 dark:text-gray-400">Try adjusting your filters</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Code Generator Modal -->
    <div id="code-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-md w-full p-8">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-white dark:bg-gray-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg overflow-hidden">
                    <img src="../assets/images/logo.png" alt="Course Corner" class="w-12 h-12">
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Referral Code Generator</h3>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Create custom referral codes with payout info</p>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Referrer Name</label>
                    <input type="text" id="admin-ref-name" placeholder="Enter Full Name"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">M-Pesa Phone Number</label>
                    <input type="tel" id="admin-ref-phone" placeholder="0712345678"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Referral Code</label>
                    <div class="flex gap-2">
                        <input type="text" id="generated-code" readonly
                            class="flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-primary-600 dark:text-primary-400 font-mono font-bold text-center"
                            placeholder="XXXXX" value="XXXXX">
                        <button onclick="generateAdminReferralCode()" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="saveAndGenerateAdminCode()" id="save-gen-btn"
                    class="w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-4 rounded-xl font-bold hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg shadow-primary-500/20">
                    <i class="fas fa-save mr-2"></i>Save & Copy Link
                </button>
                <button onclick="closeCodeGenerator()"
                    class="w-full py-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div
                class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
                <div class="flex items-center gap-3">
                    <img src="../assets/images/logo.png" alt="Course Corner" class="w-8 h-8 rounded-lg">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">Transaction Details</h3>
                </div>
                <button onclick="closeModal()"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-400"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="modal-content" class="p-6"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCt_mM9mwRg0QJpHC4haH7ZsLspVNJI6XM",
            authDomain: "course-corner.firebaseapp.com",
            projectId: "course-corner",
            storageBucket: "course-corner.firebasestorage.app",
            messagingSenderId: "961706784572",
            appId: "1:961706784572:web:7aa6c24946570ffda59039"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // API endpoints - Primary (Express server) and Fallback (Vercel serverless)
        const API_PRIMARY = 'https://course-corner-server.vercel.app';
        // Use deployed Vercel URL for fallback - replace with your actual domain
        const API_FALLBACK = 'https://coursecornerkenya.com';
        let API_BASE = API_PRIMARY; // Will switch to fallback if primary fails
        console.log('ðŸŒ API_PRIMARY:', API_PRIMARY);
        console.log('ðŸŒ API_FALLBACK:', API_FALLBACK);
        let allTransactions = [], filteredTransactions = [], currentTransactionId = null;
        const db = firebase.firestore();

        // Theme
        function initTheme() {
            const saved = localStorage.getItem('admin-theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('admin-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        initTheme();

        // Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        // Auth
        auth.onAuthStateChanged(user => handleAdminAuthState(user, showDashboard));

        function showLogin() { document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('dashboard').classList.add('hidden'); }
        function showDashboard(user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('sidebar-email').textContent = user.email;
            loadData();
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            document.getElementById('login-btn-text').textContent = 'Signing in...';
            document.getElementById('login-spinner').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');

            try {
                const result = await auth.signInWithEmailAndPassword(email, password);
                if (!isAuthorizedAdmin(result.user)) {
                    await auth.signOut();
                    throw { code: 'auth/unauthorized', message: 'Unauthorized: Admin access only.' };
                }
            }
            catch (error) {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-error-message').textContent = getAuthError(error.code);
            } finally {
                btn.disabled = false;
                document.getElementById('login-btn-text').textContent = 'Sign In';
                document.getElementById('login-spinner').classList.add('hidden');
            }
        });

        function getAuthError(code) {
            return {
                'auth/invalid-email': 'Invalid email.',
                'auth/user-not-found': 'No account found.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Invalid credentials.',
                'auth/unauthorized': 'Access denied: Admin only.'
            }[code] || 'Login failed.';
        }
        function logout() { auth.signOut(); }

        // Navigation
        function switchPage(page) {
            document.getElementById('page-dashboard').classList.add('hidden');
            document.getElementById('page-transactions').classList.add('hidden');
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-600', 'dark:text-primary-400'));
            const nav = document.getElementById(`nav-${page}`);
            if (nav) nav.classList.add('bg-primary-50', 'dark:bg-primary-900/20', 'text-primary-600', 'dark:text-primary-400');
            document.getElementById('page-title').textContent = { dashboard: 'Dashboard', transactions: 'Transactions' }[page] || page;
            document.getElementById('page-subtitle').textContent = { dashboard: 'Overview of your business', transactions: 'All payment records' }[page] || '';
            if (window.innerWidth < 1024) toggleSidebar();
        }

        // Data
        async function loadData() { await loadTransactions(); }
        async function loadTransactions() {
            try {
                // Try primary API first (Express server)
                console.log(`ðŸš€ [Admin] Trying PRIMARY: ${API_PRIMARY}/api/mpesa/admin/transactions?limit=200`);

                let res, data;
                let usedFallback = false;

                try {
                    res = await fetch(`${API_PRIMARY}/api/mpesa/admin/transactions?limit=200`, {
                        signal: AbortSignal.timeout(10000) // 10 second timeout
                    });
                    data = await res.json();
                    console.log(`ðŸ“¡ [Admin] PRIMARY response:`, data);
                } catch (primaryError) {
                    console.warn('âš ï¸ PRIMARY API failed, trying FALLBACK:', primaryError.message);
                    usedFallback = true;
                }

                // If primary failed or returned no data, try fallback
                if (usedFallback || !data?.success || (data?.data?.length === 0)) {
                    console.log(`ðŸ”„ [Admin] Trying FALLBACK: ${API_FALLBACK}/api/admin/transactions?limit=200`);
                    try {
                        res = await fetch(`${API_FALLBACK}/api/admin/transactions?limit=200`);
                        data = await res.json();
                        console.log(`ðŸ“¡ [Admin] FALLBACK response:`, data);
                        if (data.success) {
                            API_BASE = API_FALLBACK;
                            usedFallback = true;
                        }
                    } catch (fallbackError) {
                        console.error('âŒ FALLBACK also failed:', fallbackError.message);
                    }
                }

                if (usedFallback) {
                    showToast('Using fallback API', 'warning');
                }

                console.log('ðŸ“¦ [Admin] Final data:', data);

                if (data.success) {
                    allTransactions = data.data || [];
                    filteredTransactions = [...allTransactions];

                    // DEBUG: Log all transactions with their status
                    console.log('ðŸ“Š [Admin] Transactions breakdown:');
                    allTransactions.forEach((tx, idx) => {
                        console.log(`  ${idx + 1}. ${tx.status.toUpperCase()} - ${tx.phoneNumber} - KSH ${tx.amount} - Receipt: ${tx.mpesaReceiptNumber || 'N/A'}`);
                    });

                    // Calculate stats from transactions
                    const s = { total: 0, completed: 0, pending: 0, failed: 0, completedAmount: 0 };
                    allTransactions.forEach(tx => {
                        s.total++;
                        if (tx.status === 'completed') { s.completed++; s.completedAmount += tx.amount || 0; }
                        else if (tx.status === 'pending') { s.pending++; }
                        else if (tx.status === 'failed') { s.failed++; }
                    });

                    console.log('ðŸ“ˆ [Admin] Stats:', s);

                    document.getElementById('stat-total').textContent = s.total;
                    document.getElementById('stat-completed').textContent = s.completed;
                    document.getElementById('stat-failed').textContent = s.failed;
                    document.getElementById('stat-revenue').textContent = `KSH ${(s.completedAmount || 0).toLocaleString()}`;
                    if (s.total > 0) document.getElementById('stat-completed-pct').textContent = `${Math.round((s.completed / s.total) * 100)}%`;
                    renderRecentTransactions();
                    renderTransactionsTable();
                    updateResultsCount();
                } else { showToast('Failed to load', 'error'); }
            } catch (e) { console.error(e); showToast('Error connecting', 'error'); }
        }

        function renderRecentTransactions() {
            const c = document.getElementById('recent-transactions');
            const r = allTransactions.slice(0, 10);
            if (!r.length) { c.innerHTML = '<div class="p-8 text-center"><i class="fas fa-inbox text-gray-300 dark:text-gray-600 text-4xl mb-3"></i><p class="text-gray-500 dark:text-gray-400">No transactions</p></div>'; return; }
            c.innerHTML = r.map(tx => `
                <div class="flex items-center gap-4 p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer" onclick="showDetail('${tx.id}')">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center ${getStatusBg(tx.status)}"><i class="fas ${getStatusIcon(tx.status)} text-lg"></i></div>
                    <div class="flex-1 min-w-0"><p class="font-semibold text-gray-900 dark:text-white">${formatPhone(tx.phoneNumber)}</p><p class="text-sm text-gray-500 dark:text-gray-400">${tx.mpesaReceiptNumber || 'No Receipt'} ${tx.referralCode ? '<span class="text-purple-500">â€¢ ' + tx.referralCode + '</span>' : ''}</p></div>
                    <div class="text-right"><p class="font-bold text-gray-900 dark:text-white">KSH ${tx.amount || 0}</p><p class="text-xs text-gray-500 dark:text-gray-400">${formatDate(tx.createdAt)}</p></div>
                </div>`).join('');
        }

        function renderTransactionsTable() {
            const t = document.getElementById('transactions-body');
            const e = document.getElementById('empty-state');
            if (!filteredTransactions.length) { t.innerHTML = ''; e.classList.remove('hidden'); return; }
            e.classList.add('hidden');
            t.innerHTML = filteredTransactions.map(tx => `
                <tr class="table-row">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="tx-checkbox w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500" value="${tx.id}" onchange="updateBulkActions()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">${formatDate(tx.createdAt)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">${formatPhone(tx.phoneNumber)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900 dark:text-white">KSH ${tx.amount || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-3 py-1 rounded-full text-xs font-medium ${getPackageBadge(tx.category)}">${formatCategory(tx.category)}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(tx.status)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono text-sm font-bold ${tx.mpesaReceiptNumber ? 'text-primary-600 dark:text-primary-400' : 'text-gray-400'}">${tx.mpesaReceiptNumber || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono text-sm ${tx.referralCode ? 'text-purple-600 dark:text-purple-400 font-bold' : 'text-gray-400'}">${tx.referralCode || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                            <button onclick="showDetail('${tx.id}')" class="p-2 text-gray-400 hover:text-primary-600 dark:hover:text-primary-400"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteTransaction('${tx.id}')" class="p-2 text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`).join('');
            document.getElementById('select-all-transactions').checked = false;
            updateBulkActions();
        }

        function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-KE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'; }
        function formatPhone(p) { if (!p) return '-'; const str = String(p); return str.replace(/(\d{3})(\d{3})(\d{3})(\d{3})/, '$1 $2 $3 $4'); }
        function formatCategory(c) {
            return {
                'calculate-cluster-points': 'Starter',
                'courses-only': 'Standard',
                'point-and-courses': 'Premium',
                'bronze': 'Bronze',
                'silver': 'Silver',
                'gold': 'Gold'
            }[c] || c || 'Standard';
        }
        function getPackageBadge(c) {
            return {
                'calculate-cluster-points': 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400',
                'courses-only': 'bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-400',
                'point-and-courses': 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400',
                'bronze': 'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400',
                'silver': 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200',
                'gold': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'
            }[c] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
        }
        function getStatusBadge(s) { return { 'completed': '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"><i class="fas fa-check-circle"></i>Completed</span>', 'pending': '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400"><i class="fas fa-clock"></i>Pending</span>', 'failed': '<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"><i class="fas fa-times-circle"></i>Failed</span>' }[s] || `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100">${s}</span>`; }
        function getStatusBg(s) { return { 'completed': 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400', 'pending': 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400', 'failed': 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400' }[s] || 'bg-gray-100'; }
        function getStatusIcon(s) { return { 'completed': 'fa-check', 'pending': 'fa-clock', 'failed': 'fa-times' }[s] || 'fa-receipt'; }

        function getMpesaIssueInfo(tx) {
            const status = (tx.status || '').toLowerCase();
            const descRaw = tx.resultDesc || '';
            const desc = descRaw.toLowerCase();
            const code = tx.resultCode != null ? String(tx.resultCode) : '';

            if (status === 'completed') return null;

            const info = { severity: status === 'failed' ? 'error' : 'warning', title: '', detail: '', suggestion: '', code: code || null };

            if (status === 'pending') {
                info.title = 'Pending â€” awaiting customer action';
                info.detail = descRaw || 'No callback received yet. This usually means the customer did not complete the prompt on their phone.';
                info.suggestion = 'Ask the customer to check their phone and enter the M-Pesa PIN. If they already paid, click â€œRe-queryâ€.';

                if (desc.includes('processing')) {
                    info.title = 'Pending â€” still processing';
                    info.suggestion = 'Wait a moment then click â€œRe-queryâ€.';
                }
                return info;
            }

            // Failed - categorize common M-Pesa failures
            if (desc.includes('wrong pin') || desc.includes('incorrect pin') || desc.includes('pin')) {
                info.title = 'Failed â€” wrong PIN';
                info.suggestion = 'Customer should retry and enter the correct M-Pesa PIN.';
            } else if (desc.includes('insufficient') || desc.includes('balance is insufficient') || desc.includes('low balance')) {
                info.title = 'Failed â€” insufficient balance';
                info.suggestion = 'Customer should top up then retry the payment.';
            } else if (desc.includes('timeout') || desc.includes('timed out') || desc.includes('time out')) {
                info.title = 'Failed â€” timeout';
                info.suggestion = 'Customer should retry; ensure phone has network and is unlocked.';
            } else if (desc.includes('cancel') || desc.includes('cancelled') || desc.includes('canceled')) {
                info.title = 'Failed â€” cancelled by user';
                info.suggestion = 'Customer should initiate payment again and complete the prompt.';
            } else if (desc.includes('unable to lock subscriber') || desc.includes('another transaction is in process') || desc.includes('in process')) {
                info.title = 'Failed â€” phone busy / another transaction running';
                info.suggestion = 'Wait 1â€“2 minutes and retry when the phone is free.';
            } else if (desc.includes('invalid amount') || desc.includes('amount is invalid')) {
                info.title = 'Failed â€” invalid amount';
                info.suggestion = 'Confirm the amount sent to M-Pesa matches the selected package.';
            } else {
                info.title = 'Failed â€” payment not completed';
                info.suggestion = 'Click â€œRe-queryâ€ to refresh, or ask customer to retry.';
            }

            info.detail = descRaw || (code ? `Failed with code: ${code}` : 'Payment failed.');
            return info;
        }

        function renderMpesaIssueBlock(tx) {
            const info = getMpesaIssueInfo(tx);
            if (!info) return '';

            const colors = info.severity === 'error'
                ? 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'
                : 'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800';

            const titleColor = info.severity === 'error' ? 'text-red-700 dark:text-red-300' : 'text-yellow-700 dark:text-yellow-300';
            const codeHtml = info.code ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Result code: <span class="font-mono font-semibold">${info.code}</span></p>` : '';

            return `
                <div class="p-4 rounded-xl ${colors}">
                    <p class="text-sm font-bold ${titleColor}">${info.title}</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${info.detail}</p>
                    ${codeHtml}
                    ${info.suggestion ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-2"><i class="fas fa-lightbulb mr-2"></i>${info.suggestion}</p>` : ''}
                </div>
            `;
        }

        // Filters
        function handleSearch() { applyAllFilters(); }
        function applyAllFilters() {
            const search = document.getElementById('search-input').value.toLowerCase().trim();
            const status = document.getElementById('status-filter').value;
            const category = document.getElementById('category-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            filteredTransactions = allTransactions.filter(tx => {
                const searchStr = search.toLowerCase();
                const phoneStr = tx.phoneNumber ? String(tx.phoneNumber).toLowerCase() : '';
                const mpesaCode = tx.mpesaReceiptNumber ? String(tx.mpesaReceiptNumber).toLowerCase() : '';
                const refCode = tx.referralCode ? String(tx.referralCode).toLowerCase() : '';
                const txId = tx.id ? String(tx.id).toLowerCase() : '';
                
                if (search && !(
                    phoneStr.includes(searchStr) || 
                    mpesaCode.includes(searchStr) || 
                    refCode.includes(searchStr) || 
                    txId.includes(searchStr)
                )) return false;
                
                if (status && tx.status !== status) return false;
                if (category && tx.category !== category) return false;
                if (dateFrom && new Date(tx.createdAt) < new Date(dateFrom)) return false;
                if (dateTo && new Date(tx.createdAt) > new Date(dateTo + 'T23:59:59')) return false;
                return true;
            });
            renderTransactionsTable();
            updateResultsCount();
        }
        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            filteredTransactions = [...allTransactions];
            renderTransactionsTable();
            updateResultsCount();
        }
        function updateResultsCount() { document.getElementById('results-count').textContent = `${filteredTransactions.length} of ${allTransactions.length}`; }

        // Modals
        function showDetail(id, opts = {}) {
            const tx = allTransactions.find(t => t.id === id);
            if (!tx) return;
            currentTransactionId = id;
            const showRequeryBtn = (tx.status === 'completed' && !tx.mpesaReceiptNumber) || tx.status === 'pending' || tx.status === 'failed';
            document.getElementById('modal-content').innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center gap-4 p-4 rounded-2xl ${getStatusBg(tx.status)}">
                        <div class="w-14 h-14 rounded-xl bg-white/50 dark:bg-black/20 flex items-center justify-center"><i class="fas ${getStatusIcon(tx.status)} text-2xl"></i></div>
                        <div><p class="text-sm opacity-75">Status</p><p class="text-xl font-bold capitalize">${tx.status}</p></div>
                        ${showRequeryBtn ? `<button onclick="requeryTransaction('${tx.id}')" class="ml-auto px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium"><i class="fas fa-sync-alt mr-1"></i>Re-query</button>` : ''}
                    </div>
                    ${showRequeryBtn ? `<div id="auto-requery-hint" class="text-xs text-gray-500 dark:text-gray-400">Tip: Pending/No receipt? We can check M-Pesa for the latest status.</div>` : ''}
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Phone</p><p class="font-semibold text-gray-900 dark:text-white">${formatPhone(tx.phoneNumber)}</p></div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Amount</p><p class="font-bold text-2xl text-primary-600 dark:text-primary-400">KSH ${tx.amount || 0}</p></div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Package</p><p class="font-semibold text-gray-900 dark:text-white">${formatCategory(tx.category)}</p></div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">M-Pesa Code</p><p class="font-mono font-bold ${tx.mpesaReceiptNumber ? 'text-primary-600 dark:text-primary-400' : 'text-gray-400'}">${tx.mpesaReceiptNumber || 'Not captured'}</p></div>
                    </div>
                    ${tx.referralCode ? `<div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl border border-purple-200 dark:border-purple-800"><p class="text-xs text-purple-600 dark:text-purple-400 mb-1">Referral Code</p><p class="font-mono font-bold text-purple-700 dark:text-purple-300">${tx.referralCode}</p></div>` : ''}
                    ${renderMpesaIssueBlock(tx)}
                    ${tx.resultDesc ? `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl"><p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Result</p><p class="text-sm text-gray-700 dark:text-gray-300">${tx.resultDesc}</p></div>` : ''}
                    <div class="text-sm text-gray-500 dark:text-gray-400"><i class="fas fa-calendar mr-2"></i>${formatDate(tx.createdAt)}</div>
                </div>`;
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');

            if (!opts.skipAutoRequery && showRequeryBtn) {
                autoRequeryForDetail(id);
            }
        }

        async function autoRequeryForDetail(transactionId) {
            const hintEl = document.getElementById('auto-requery-hint');
            if (!hintEl) return;
            hintEl.textContent = 'Checking M-Pesa status...';
            try {
                const res = await fetch(`${API_BASE}/api/mpesa/admin/requery/${transactionId}`, { method: 'POST' });
                const data = await res.json();

                if (data.success && data.updated) {
                    hintEl.textContent = 'Updated from M-Pesa. Refreshing details...';
                    await loadTransactions();
                    showDetail(transactionId, { skipAutoRequery: true });
                    return;
                }

                hintEl.textContent = data.success ? 'No updates available from M-Pesa yet.' : ('Re-query failed: ' + (data.message || 'Unknown error'));
            } catch (e) {
                hintEl.textContent = 'Re-query error: ' + (e.message || e);
            }
        }
        function closeModal() { document.getElementById('detail-modal').classList.add('hidden'); document.getElementById('detail-modal').classList.remove('flex'); }

        // Code Generator - Admin can generate UNLIMITED codes, all stored permanently
        let generatedCodes = JSON.parse(localStorage.getItem('adminCodes') || '[]');

        function openCodeGenerator() {
            document.getElementById('admin-ref-name').value = '';
            document.getElementById('admin-ref-phone').value = '';
            document.getElementById('generated-code').value = 'XXXXX';
            document.getElementById('code-modal').classList.remove('hidden');
            document.getElementById('code-modal').classList.add('flex');
        }
        function closeCodeGenerator() { document.getElementById('code-modal').classList.add('hidden'); document.getElementById('code-modal').classList.remove('flex'); }

        function generateAdminReferralCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 5; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('generated-code').value = code;
            return code;
        }

        async function saveAndGenerateAdminCode() {
            const name = document.getElementById('admin-ref-name').value.trim();
            const phone = document.getElementById('admin-ref-phone').value.trim();
            let code = document.getElementById('generated-code').value;

            if (!name || !phone) {
                showToast('Please enter name and phone number', 'warning');
                return;
            }

            if (code === 'XXXXX') {
                code = generateAdminReferralCode();
            }

            const btn = document.getElementById('save-gen-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            try {
                // Formatting phone
                let cleanPhone = phone.replace(/[^0-9]/g, '');
                if (cleanPhone.startsWith('0')) cleanPhone = '254' + cleanPhone.substring(1);
                else if (cleanPhone.startsWith('+')) cleanPhone = cleanPhone.substring(1);
                else if (!cleanPhone.startsWith('254') && cleanPhone.length === 9) cleanPhone = '254' + cleanPhone;

                // Save to referralCodes collection
                await db.collection('referralCodes').doc(code).set({
                    code: code,
                    userId: auth.currentUser?.uid || 'admin',
                    userEmail: auth.currentUser?.email || 'admin@coursecorner.com',
                    userName: name,
                    displayName: name,
                    phoneNumber: cleanPhone,
                    createdAt: new Date().toISOString(),
                    totalReferrals: 0,
                    paidReferrals: 0,
                    totalEarnings: 0,
                    pendingPayout: 0,
                    isActive: true,
                    isAdminGenerated: true,
                    source: 'admin-manual'
                });

                // Check if user exists with this phone (to link it)
                const userSnapshot = await db.collection('users')
                    .where('phoneNumber', '==', cleanPhone)
                    .limit(1)
                    .get();

                if (!userSnapshot.empty) {
                    await userSnapshot.docs[0].ref.update({
                        referralCode: code,
                        displayName: name // Update name to match record
                    });
                } else {
                    // Create a placeholder user doc so it shows up in the referrals table
                    await db.collection('users').add({
                        displayName: name,
                        phoneNumber: cleanPhone,
                        referralCode: code,
                        referralCount: 0,
                        referralEarnings: 0,
                        referralPending: 0,
                        referralPaidCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        isAdminAdded: true
                    });
                }

                // Copy to clipboard
                await navigator.clipboard.writeText('https://coursecornerkenya.com/#ref=' + code);
                showToast('Code saved & Link copied!', 'success');
                closeCodeGenerator();
                
                // Add to local history for convenience
                if (!generatedCodes.includes(code)) {
                    generatedCodes.unshift(code);
                    localStorage.setItem('adminCodes', JSON.stringify(generatedCodes));
                }
            } catch (error) {
                console.error('Error saving code:', error);
                showToast('Failed to save code: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>Save & Copy Link';
            }
        }

        function copyGeneratedCode() {
            const code = document.getElementById('generated-code').value;
            if (!code || code === 'XXXXX') { showToast('Generate first', 'warning'); return; }
            navigator.clipboard.writeText('https://coursecornerkenya.com/#ref=' + code).then(() => showToast('Link copied!', 'success'));
        }
        function updateCodesHistory() {
            const c = document.getElementById('codes-history'), l = document.getElementById('codes-list');
            if (!generatedCodes.length) { c.classList.add('hidden'); return; }
            c.classList.remove('hidden');
            l.innerHTML = generatedCodes.map(code => `<span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm font-mono cursor-pointer hover:bg-primary-100 dark:hover:bg-primary-900/30" onclick="selectCode('${code}')">${code}</span>`).join('');
        }
        function selectCode(code) { document.getElementById('generated-code').value = code; copyGeneratedCode(); }

        // Actions
        async function syncFailedTransactions() { 
            showToast('Syncing failed transactions...', 'info'); 
            try {
                // Call bulk sync endpoint
                const res = await fetch(`${API_BASE}/api/mpesa/admin/sync-all`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    showToast(`Sync complete! ${data.results?.length || 0} checked.`, 'success');
                } else {
                    showToast(data.message || 'Sync failed', 'warning');
                }
            } catch (e) {
                console.error('Sync error:', e);
                showToast('Error connecting to sync service', 'error');
            }
            await loadTransactions(); 
        }







        async function requeryTransaction(transactionId) {
            showToast('Re-querying M-Pesa...', 'info');
            try {
                const res = await fetch(`${API_BASE}/api/mpesa/admin/requery/${transactionId}`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    if (data.updated) {
                        showToast('Transaction updated!', 'success');
                        await loadTransactions();
                    } else {
                        showToast('No updates available', 'warning');
                    }
                    console.log('Requery result:', data);
                } else {
                    showToast('Requery failed: ' + data.message, 'error');
                }
            } catch (e) {
                console.error('Requery error:', e);
                showToast('Requery error: ' + e.message, 'error');
            }
        }

        function refreshData() { loadData(); showToast('Refreshed', 'success'); }
        function exportToCSV() {
            if (!filteredTransactions.length) { showToast('No data', 'warning'); return; }
            let csv = 'Date,Phone,Amount,Package,Status,M-Pesa\n';
            filteredTransactions.forEach(tx => { csv += `"${formatDate(tx.createdAt)}","${tx.phoneNumber}","${tx.amount}","${formatCategory(tx.category)}","${tx.status}","${tx.mpesaReceiptNumber || ''}"\n`; });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            link.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showToast('CSV exported', 'success');
        }
        function exportToPDF() {
            if (!filteredTransactions.length) { showToast('No data', 'warning'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.setTextColor(22, 163, 74);
            doc.text('Course Corner - Transactions', 14, 22);
            doc.autoTable({ startY: 35, head: [['Date', 'Phone', 'Amount', 'Package', 'Status', 'M-Pesa']], body: filteredTransactions.map(tx => [formatDate(tx.createdAt), tx.phoneNumber || '-', `KSH ${tx.amount || 0}`, formatCategory(tx.category), tx.status, tx.mpesaReceiptNumber || '-']), theme: 'striped', headStyles: { fillColor: [22, 163, 74] } });
            doc.save(`transactions_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('PDF generated', 'success');
        }

        // Selection & Delete
        function toggleSelectAllTransactions() {
            const checked = document.getElementById('select-all-transactions').checked;
            document.querySelectorAll('.tx-checkbox').forEach(cb => cb.checked = checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.tx-checkbox:checked');
            const bar = document.getElementById('bulk-actions');
            const count = document.getElementById('selected-count');
            if (selected.length > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selected.length} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction? This cannot be undone.')) return;
            try {
                await db.collection('transactions').doc(id).delete();
                showToast('Transaction deleted', 'success');
                loadTransactions();
            } catch (e) {
                console.error(e);
                showToast('Error deleting transaction', 'error');
            }
        }

        async function deleteSelectedTransactions() {
            const selected = Array.from(document.querySelectorAll('.tx-checkbox:checked')).map(cb => cb.value);
            if (!selected.length) return;
            if (!confirm(`Are you sure you want to delete ${selected.length} transactions? This cannot be undone.`)) return;

            showToast(`Deleting ${selected.length} items...`, 'info');
            try {
                const batch = db.batch();
                selected.forEach(id => {
                    batch.delete(db.collection('transactions').doc(id));
                });
                await batch.commit();
                showToast(`Successfully deleted ${selected.length} items`, 'success');
                loadTransactions();
            } catch (e) {
                console.error(e);
                showToast('Error in bulk delete', 'error');
            }
        }

        // Toast
        function showToast(msg, type = 'info') {
            const c = document.getElementById('toast-container');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const t = document.createElement('div');
            t.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 animate-slide-in`;
            t.innerHTML = `<i class="fas ${icons[type]}"></i><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Init
        switchPage('dashboard');
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); closeCodeGenerator(); } });
        document.getElementById('detail-modal').addEventListener('click', function (e) { if (e.target === this) closeModal(); });
        document.getElementById('code-modal').addEventListener('click', function (e) { if (e.target === this) closeCodeGenerator(); });
    </script>
</body>

</html>