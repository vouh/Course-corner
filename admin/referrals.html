<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referrals - Admin Dashboard</title>
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="icon" href="../favicon.ico" sizes="any">
    <link rel="manifest" href="../site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/admin-auth.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
                            400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
                            800: '#166534', 900: '#14532d',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #374151;
            border-top-color: #22c55e;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .sidebar {
            transition: transform 0.3s ease;
        }

        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.15);
        }

        .dark .hover-lift:hover {
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.4);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slide-in 0.3s ease;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <!-- Auth Check -->
    <div id="auth-check" class="min-h-screen flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed left-0 top-0 h-full w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-40 sidebar -translate-x-full lg:translate-x-0">
            <div class="h-20 flex items-center gap-3 px-6 border-b border-gray-200 dark:border-gray-700">
                <img src="../assets/images/logo.png" alt="Course Corner" class="w-12 h-12 rounded-xl shadow-lg">
                <div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">Course Corner</h1>
                    <p class="text-xs text-gray-500 dark:text-gray-400">Admin Panel</p>
                </div>
            </div>

            <nav class="p-4 space-y-2">
                <a href="index.html"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-chart-pie text-xl w-6"></i>
                    <span>Dashboard</span>
                </a>
                <a href="index.html#transactions"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-receipt text-xl w-6"></i>
                    <span>Transactions</span>
                </a>
                <a href="referrals.html"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400 font-medium">
                    <i class="fas fa-users text-xl w-6"></i>
                    <span>Referrals</span>
                </a>
                <a href="withdrawals.html"
                    class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                    <i class="fas fa-money-bill-wave text-xl w-6"></i>
                    <span>Withdrawals</span>
                </a>

                <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <p
                        class="px-4 text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider mb-2">
                        Tools</p>
                    <a href="#" onclick="openCodeGenerator()"
                        class="nav-item flex items-center gap-4 px-4 py-3 rounded-xl text-gray-700 dark:text-gray-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 hover:text-primary-600 dark:hover:text-primary-400 transition-all font-medium">
                        <i class="fas fa-gift text-xl w-6"></i>
                        <span>Code Generator</span>
                    </a>
                </div>
            </nav>

            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="sidebar-email" class="text-sm font-medium text-gray-900 dark:text-white truncate">
                            admin@email.com</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Administrator</p>
                    </div>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-red-500 transition-colors"
                        title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:ml-72 min-h-screen">
            <!-- Top Bar -->
            <header
                class="h-20 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30 px-4 lg:px-8 flex items-center justify-between">
                <button onclick="toggleSidebar()"
                    class="lg:hidden p-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="hidden lg:block">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Referrals</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Manage referral codes and earnings</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="syncReferralData()"
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-semibold transition-all flex items-center gap-2"
                        title="Sync from Transactions">
                        <i class="fas fa-sync"></i>
                        <span class="hidden sm:inline">Sync Data</span>
                    </button>
                    <button onclick="loadReferrals()"
                        class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Refresh">
                        <i class="fas fa-sync-alt text-lg"></i>
                    </button>
                    <button onclick="toggleTheme()"
                        class="p-3 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Toggle Theme">
                        <i class="fas fa-sun text-lg dark:hidden"></i>
                        <i class="fas fa-moon text-lg hidden dark:inline"></i>
                    </button>
                </div>
            </header>

            <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden">
            </div>

            <main class="p-4 lg:p-8">
                <!-- Stats -->
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                    <div
                        class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-users text-white text-2xl"></i>
                            </div>
                        </div>
                        <p id="stat-total-referrers" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Referrers</p>
                    </div>

                    <div
                        class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-user-plus text-white text-2xl"></i>
                            </div>
                        </div>
                        <p id="stat-total-referrals" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Referrals</p>
                    </div>

                    <div
                        class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-coins text-white text-2xl"></i>
                            </div>
                        </div>
                        <p id="stat-total-earnings" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Earnings</p>
                    </div>

                    <div
                        class="hover-lift bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="flex items-center justify-between mb-4">
                            <div
                                class="w-14 h-14 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <i class="fas fa-wallet text-white text-2xl"></i>
                            </div>
                        </div>
                        <p id="stat-pending-payout" class="text-4xl font-bold text-gray-900 dark:text-white mb-1">-</p>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Pending Payouts</p>
                    </div>
                </div>

                <!-- Search & Filters -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2 flex gap-2">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Search by name, code, phone, or email..."
                                    class="w-full pl-12 pr-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white"
                                    onkeyup="filterReferrals()">
                            </div>
                            <button onclick="filterReferrals()" class="px-5 bg-primary-500 hover:bg-primary-600 text-white rounded-xl transition-all">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <div id="bulk-actions"
                                class="hidden flex items-center gap-2 px-4 py-1 bg-primary-50 dark:bg-primary-900/20 border border-primary-100 dark:border-primary-800 rounded-xl animate-slide-in">
                                <span id="selected-count"
                                    class="text-sm font-bold text-primary-700 dark:text-primary-300">0</span>
                                <button onclick="deleteSelectedReferrers()"
                                    class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors"
                                    title="Delete Selected">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <button onclick="openCodeGenerator()"
                                class="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-xl font-semibold hover:from-primary-600 hover:to-primary-700 transition-all">
                                <i class="fas fa-plus"></i>
                                <span>Generate Code</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Referrers Table -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-left">
                                        <input type="checkbox" id="select-all-referrers"
                                            onchange="toggleSelectAllReferrers()"
                                            class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    </th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Referrer</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Code</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Referrals</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Earnings</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Balance</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Status</th>
                                    <th
                                        class="px-6 py-4 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="referrals-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                                <tr>
                                    <td colspan="8" class="px-6 py-12 text-center">
                                        <div class="loader mx-auto mb-4"></div>
                                        <p class="text-gray-500 dark:text-gray-400">Loading referrals...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="empty-state" class="hidden p-12 text-center">
                        <div
                            class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-users-slash text-gray-400 text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No Referrers Found</h3>
                        <p class="text-gray-500 dark:text-gray-400">No referral data available yet</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Code Generator Modal -->
    <div id="code-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-md w-full p-8 overflow-y-auto max-h-[95vh]">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-magic text-white text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Admin Code Generator</h3>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Create custom referral codes</p>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Referrer Name</label>
                    <input type="text" id="admin-ref-name" placeholder="Enter Full Name"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">M-Pesa Phone Number</label>
                    <input type="tel" id="admin-ref-phone" placeholder="0712345678"
                        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Referral Code</label>
                    <div class="flex gap-2">
                        <input type="text" id="generated-code" readonly
                            class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl text-primary-600 dark:text-primary-400 font-mono font-bold text-center"
                            value="XXXXX">
                        <button onclick="generateCode()" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="gen-result" class="hidden mb-6 p-4 bg-primary-50 dark:bg-primary-900/20 rounded-2xl border border-primary-100 dark:border-primary-800">
                <p class="text-xs text-primary-600 dark:text-primary-400 font-bold uppercase mb-2">Referral Link Created!</p>
                <div class="flex items-center gap-2">
                    <input type="text" id="result-link" readonly class="flex-1 bg-transparent border-none p-0 text-sm font-medium text-gray-900 dark:text-white outline-none">
                    <button onclick="copyToClipboard('result-link')" class="p-2 text-primary-600 hover:bg-primary-100 rounded-lg">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="saveAndGenerate()" id="save-gen-btn"
                    class="w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-4 rounded-xl font-bold hover:from-primary-600 hover:to-primary-700 transition-all shadow-lg shadow-primary-500/20">
                    <i class="fas fa-save mr-2"></i>Save & Generate Link
                </button>
                <button onclick="closeCodeGenerator()"
                    class="w-full py-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div
                class="p-6 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Referrer Details</h3>
                <button onclick="closeDetailModal()"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg text-gray-400"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="detail-content" class="p-6"></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCt_mM9mwRg0QJpHC4haH7ZsLspVNJI6XM",
            authDomain: "course-corner.firebaseapp.com",
            projectId: "course-corner",
            storageBucket: "course-corner.firebasestorage.app",
            messagingSenderId: "961706784572",
            appId: "1:961706784572:web:7aa6c24946570ffda59039"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allReferrers = [], filteredReferrers = [];

        // Theme
        function initTheme() {
            const saved = localStorage.getItem('admin-theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('admin-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        initTheme();

        // Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        // Auth
        auth.onAuthStateChanged(user => handleAdminAuthState(user, (u) => {
            document.getElementById('auth-check').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('sidebar-email').textContent = u.email;
            loadReferrals();
        }));

        function logout() { auth.signOut().then(() => window.location.href = 'index.html'); }

        // Load Referrals from Firestore - queries users with referralCode
        async function loadReferrals() {
            try {
                // Query users who have a referral code (single source of truth)
                const snapshot = await db.collection('users')
                    .where('referralCode', '!=', '')
                    .get();

                allReferrers = [];
                let totalEarnings = 0, totalReferrals = 0, pendingPayout = 0;

                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    // Only include users with a referral code AND who have actually referred someone or earned
                    if (data.referralCode && ((data.referralCount || 0) > 0 || (data.referralEarnings || 0) > 0)) {
                        allReferrers.push(data);
                        totalEarnings += data.referralEarnings || 0;
                        totalReferrals += data.referralCount || 0;
                        pendingPayout += data.referralPending || 0;
                    }
                });

                // Sort by earnings descending
                allReferrers.sort((a, b) => (b.referralEarnings || 0) - (a.referralEarnings || 0));
                filteredReferrers = [...allReferrers];

                document.getElementById('stat-total-referrers').textContent = allReferrers.length;
                document.getElementById('stat-total-referrals').textContent = totalReferrals;
                document.getElementById('stat-total-earnings').textContent = `KSH ${totalEarnings.toLocaleString()}`;
                document.getElementById('stat-pending-payout').textContent = `KSH ${pendingPayout.toLocaleString()}`;

                renderTable();
            } catch (e) {
                console.error('Error loading referrals:', e);
                showToast('Failed to load referrals', 'error');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('referrals-body');
            const empty = document.getElementById('empty-state');

            if (!filteredReferrers.length) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            tbody.innerHTML = filteredReferrers.map(r => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                    <td class="px-6 py-4">
                        <input type="checkbox" class="referrer-checkbox w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500" value="${r.id}" onchange="updateBulkActions()">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-semibold">${(r.phoneNumber || r.displayName || r.email || 'U')[0].toUpperCase()}</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">${r.phoneNumber || r.displayName || '-'}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${r.email || '-'}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg font-mono font-bold">${r.referralCode || '-'}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-2xl font-bold text-gray-900 dark:text-white">${r.referralCount || 0}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-emerald-600 dark:text-emerald-400">KSH ${(r.referralEarnings || 0).toLocaleString()}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-amber-600 dark:text-amber-400">KSH ${(r.referralPending || 0).toLocaleString()}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${(r.referralPending || 0) > 0 ? '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">Pending</span>' : '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Paid</span>'}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <button onclick="showDetail('${r.id}')" class="p-2 text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors" title="View Details">
                                <i class="fas fa-eye text-lg"></i>
                            </button>
                            <button onclick="markAsPaid('${r.id}', ${r.referralPending || 0}, '${r.phoneNumber || r.displayName || r.email || ''}')" 
                                class="p-2 ${(r.referralPending || 0) > 0 ? 'text-amber-500 hover:text-green-600' : 'text-gray-300 cursor-not-allowed'}" 
                                title="Mark as Paid" ${(r.referralPending || 0) === 0 ? 'disabled' : ''}>
                                <i class="fas fa-money-bill-wave text-lg"></i>
                            </button>
                            <button onclick="deleteReferrer('${r.id}')" class="p-2 text-gray-400 hover:text-red-500 transition-colors" title="Delete">
                                <i class="fas fa-trash-alt text-lg"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('select-all-referrers').checked = false;
            updateBulkActions();
        }

        function filterReferrals() {
            const search = document.getElementById('search-input').value.toLowerCase().trim();
            if (!search) {
                filteredReferrers = [...allReferrers];
            } else {
                filteredReferrers = allReferrers.filter(r =>
                    (r.referralCode && r.referralCode.toLowerCase().includes(search)) ||
                    (r.phoneNumber && r.phoneNumber.includes(search)) ||
                    (r.displayName && r.displayName.toLowerCase().includes(search)) ||
                    (r.email && r.email.toLowerCase().includes(search))
                );
            }
            renderTable();
        }

        // Mark referrer as paid (manual payout)
        async function markAsPaid(userId, amount, userName) {
            if (!amount || amount <= 0) {
                showToast('No pending balance to pay', 'warning');
                return;
            }

            // Show confirmation dialog
            const confirmed = confirm(`Confirm Manual Payout\n\nUser: ${userName}\nAmount: KSH ${amount.toLocaleString()}\n\nHave you sent this amount via M-Pesa?\nClick OK to mark as paid and reset their balance to 0.`);

            if (!confirmed) return;

            try {
                // Update user's referralPending to 0
                await db.collection('users').doc(userId).update({
                    referralPending: 0,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Log the payout in withdrawals collection for record keeping
                await db.collection('withdrawals').add({
                    userId: userId,
                    amount: amount,
                    status: 'completed',
                    paidBy: 'admin-manual',
                    paidAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showToast(`Marked KSH ${amount.toLocaleString()} as paid!`, 'success');
                loadReferrals(); // Refresh table
            } catch (e) {
                console.error('Error marking as paid:', e);
                showToast('Failed to update. Please try again.', 'error');
            }
        }

        // Show referrer detail
        function showDetail(id) {
            const r = allReferrers.find(ref => ref.id === id);
            if (!r) return;

            document.getElementById('detail-content').innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center gap-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-2xl">
                        <div class="w-16 h-16 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-2xl font-bold">${(r.phoneNumber || r.displayName || r.email || 'U')[0].toUpperCase()}</span>
                        </div>
                        <div>
                            <p class="text-xl font-bold text-gray-900 dark:text-white">${r.displayName || r.phoneNumber || 'No Name'}</p>
                            <p class="text-gray-500 dark:text-gray-400">${r.email || 'No Email'}</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500">${r.phoneNumber || 'No Phone'}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Referral Code</p>
                            <p class="font-mono font-bold text-xl text-purple-600 dark:text-purple-400">${r.referralCode || '-'}</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Total Referrals</p>
                            <p class="font-bold text-xl text-gray-900 dark:text-white">${r.referralCount || 0}</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Total Earnings</p>
                            <p class="font-bold text-xl text-emerald-600 dark:text-emerald-400">KSH ${(r.referralEarnings || 0).toLocaleString()}</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Pending Balance</p>
                            <p class="font-bold text-xl text-amber-600 dark:text-amber-400">KSH ${(r.referralPending || 0).toLocaleString()}</p>
                        </div>
                    </div>

                    ${(r.referralPending || 0) > 0 ? `
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <button onclick="markAsPaid('${r.id}', ${r.referralPending}, '${r.displayName || r.phoneNumber || r.email || ''}'); closeDetailModal();" 
                            class="w-full py-3 px-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-money-bill-wave"></i>
                            Mark KSH ${(r.referralPending || 0).toLocaleString()} as Paid
                        </button>
                    </div>
                    ` : ''}

                    ${r.referrals && r.referrals.length > 0 ? `
                    <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Recent Referrals</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${r.referrals.map(ref => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <span class="text-gray-600 dark:text-gray-300">${ref.phone || ref.referredPhone || '-'}</span>
                                    <span class="text-xs text-gray-400">${ref.date ? new Date(ref.date).toLocaleDateString() : '-'}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <i class="fas fa-calendar mr-2"></i>Joined: ${r.createdAt ? new Date(r.createdAt.toDate ? r.createdAt.toDate() : r.createdAt).toLocaleDateString() : '-'}
                    </div>
                </div>
            `;

            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
        }

        // Code Generator
        function openCodeGenerator() {
            document.getElementById('admin-ref-name').value = '';
            document.getElementById('admin-ref-phone').value = '';
            document.getElementById('generated-code').value = 'XXXXX';
            document.getElementById('gen-result').classList.add('hidden');
            document.getElementById('code-modal').classList.remove('hidden');
            document.getElementById('code-modal').classList.add('flex');
        }

        function closeCodeGenerator() {
            document.getElementById('code-modal').classList.add('hidden');
            document.getElementById('code-modal').classList.remove('flex');
        }

        function generateUniqueCodeSnippet() {
            let code = '';
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            for (let i = 0; i < 6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            return code;
        }

        function generateCode() {
            const code = generateUniqueCodeSnippet();
            document.getElementById('generated-code').value = code;
            return code;
        }

        async function saveAndGenerate() {
            const name = document.getElementById('admin-ref-name').value.trim();
            const phone = document.getElementById('admin-ref-phone').value.trim();
            let code = document.getElementById('generated-code').value;

            if (!name || !phone) {
                showToast('Please enter name and phone number', 'warning');
                return;
            }

            if (code === 'XXXXX') {
                code = generateCode();
            }

            const btn = document.getElementById('save-gen-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            try {
                // Formatting phone
                let cleanPhone = phone.replace(/[^0-9]/g, '');
                if (cleanPhone.startsWith('0')) cleanPhone = '254' + cleanPhone.substring(1);
                if (cleanPhone.startsWith('+')) cleanPhone = cleanPhone.substring(1);

                // Save to referralCodes collection
                await db.collection('referralCodes').doc(code).set({
                    code: code,
                    userName: name,
                    displayName: name,
                    phoneNumber: cleanPhone,
                    isActive: true,
                    totalEarnings: 0,
                    totalReferrals: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'admin',
                    source: 'admin-manual'
                });

                // Check if user exists with this phone (to link it)
                const userSnapshot = await db.collection('users')
                    .where('phoneNumber', '==', cleanPhone)
                    .limit(1)
                    .get();

                if (!userSnapshot.empty) {
                    await userSnapshot.docs[0].ref.update({
                        referralCode: code,
                        lastCodeGeneratedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Create a placeholder user doc so it shows up in the referrals table
                    await db.collection('users').add({
                        displayName: name,
                        phoneNumber: cleanPhone,
                        referralCode: code,
                        referralCount: 0,
                        referralEarnings: 0,
                        referralPending: 0,
                        referralPaidCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        source: 'admin-manual'
                    });
                }

                const link = 'https://coursecornerkenya.com/#ref=' + code;
                document.getElementById('result-link').value = link;
                document.getElementById('gen-result').classList.remove('hidden');

                showToast('Referral code saved and link generated!', 'success');
                loadReferrals(); // Refresh the list
            } catch (e) {
                console.error(e);
                showToast('Error saving code: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            el.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard!', 'success');
        }

        // Toast
        function showToast(msg, type = 'info') {
            const c = document.getElementById('toast-container');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const icons = { success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
            const t = document.createElement('div');
            t.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 animate-slide-in`;
            t.innerHTML = `<i class="fas ${icons[type]}"></i><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Selection & Delete
        function toggleSelectAllReferrers() {
            const checked = document.getElementById('select-all-referrers').checked;
            document.querySelectorAll('.referrer-checkbox').forEach(cb => cb.checked = checked);
            updateBulkActions();
        }

        function updateBulkActions() {
            const selected = document.querySelectorAll('.referrer-checkbox:checked');
            const bar = document.getElementById('bulk-actions');
            const count = document.getElementById('selected-count');
            if (selected.length > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selected.length} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        async function deleteReferrer(id) {
            const ref = allReferrers.find(r => r.id === id);
            if (!ref) return;

            if (!confirm(`Are you sure you want to delete ${ref.displayName || 'this referrer'}? This will clear their referral code and earnings data. This cannot be undone.`)) return;
            
            try {
                const batch = db.batch();
                
                // 1. Clear referral data from user profile
                const userRef = db.collection('users').doc(id);
                batch.update(userRef, {
                    referralCode: firebase.firestore.FieldValue.delete(),
                    referralCount: firebase.firestore.FieldValue.delete(),
                    referralEarnings: firebase.firestore.FieldValue.delete(),
                    referralPending: firebase.firestore.FieldValue.delete(),
                    referralCreatedAt: firebase.firestore.FieldValue.delete(),
                    referralPaidCount: firebase.firestore.FieldValue.delete()
                });

                // 2. Delete the record from referralCodes collection if it exists
                if (ref.referralCode) {
                    const codeRef = db.collection('referralCodes').doc(ref.referralCode);
                    batch.delete(codeRef);
                }

                await batch.commit();

                showToast('Referrer data deleted successfully', 'success');
                loadReferrals();
            } catch (e) {
                console.error('Delete error:', e);
                showToast('Error deleting referrer: ' + e.message, 'error');
            }
        }

        async function deleteSelectedReferrers() {
            const selectedIds = Array.from(document.querySelectorAll('.referrer-checkbox:checked')).map(cb => cb.value);
            if (!selectedIds.length) return;
            
            if (!confirm(`Are you sure you want to delete ${selectedIds.length} referrers? This will clear their referral data. This cannot be undone.`)) return;

            showToast(`Deleting ${selectedIds.length} items...`, 'info');
            try {
                const batch = db.batch();
                
                selectedIds.forEach(id => {
                    const ref = allReferrers.find(r => r.id === id);
                    if (ref) {
                        // Clear user record
                        batch.update(db.collection('users').doc(id), {
                            referralCode: firebase.firestore.FieldValue.delete(),
                            referralCount: firebase.firestore.FieldValue.delete(),
                            referralEarnings: firebase.firestore.FieldValue.delete(),
                            referralPending: firebase.firestore.FieldValue.delete(),
                            referralCreatedAt: firebase.firestore.FieldValue.delete(),
                            referralPaidCount: firebase.firestore.FieldValue.delete()
                        });
                        
                        // Clear referralCodes record
                        if (ref.referralCode) {
                            batch.delete(db.collection('referralCodes').doc(ref.referralCode));
                        }
                    }
                });

                await batch.commit();
                showToast(`Successfully deleted ${selectedIds.length} items`, 'success');
                loadReferrals();
            } catch (e) {
                console.error('Bulk delete error:', e);
                showToast('Error in bulk delete: ' + e.message, 'error');
            }
        }
        async function syncReferralData() {
            try {
                showToast('Syncing referral data...', 'info');

                // 1. Get all completed transactions
                const txSnapshot = await db.collection('transactions')
                    .where('status', '==', 'completed')
                    .get();

                if (txSnapshot.empty) {
                    showToast('No completed transactions found.', 'info');
                    return;
                }

                const referralData = {}; // code -> { count, revenue, earnings }
                const COMMISSION_RATE = 0.12;

                txSnapshot.forEach(doc => {
                    const data = doc.data();
                    const code = (data.referralCode || '').toUpperCase().trim();
                    if (!code) return;

                    if (!referralData[code]) {
                        referralData[code] = { count: 0, revenue: 0, earnings: 0 };
                    }

                    referralData[code].count++;
                    const amount = parseFloat(data.amount || 0);
                    referralData[code].revenue += amount;
                    referralData[code].earnings += Math.round(amount * COMMISSION_RATE);
                });

                // 2. Update users
                let updatedCount = 0;
                for (const code in referralData) {
                    const stats = referralData[code];
                    const userSnapshot = await db.collection('users')
                        .where('referralCode', '==', code)
                        .limit(1)
                        .get();

                    if (!userSnapshot.empty) {
                        const userDoc = userSnapshot.docs[0];
                        await userDoc.ref.update({
                            referralCount: stats.count,
                            referralPaidCount: stats.count,
                            referralEarnings: stats.earnings,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Sync with referralCodes collection if exists
                        try {
                            const codeRef = db.collection('referralCodes').doc(code);
                            const codeDoc = await codeRef.get();
                            if (codeDoc.exists) {
                                await codeRef.update({
                                    totalReferrals: stats.count,
                                    paidReferrals: stats.count,
                                    totalEarnings: stats.earnings,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        } catch (e) { }

                        updatedCount++;
                    }
                }

                // 3. Sync Withdrawal metadata (backfill)
                const withdrawalSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .get();

                let withdrawalsSynced = 0;
                for (const wDoc of withdrawalSnapshot.docs) {
                    const wData = wDoc.data();
                    if (!wData.userId) continue;

                    const userDoc = await db.collection('users').doc(wData.userId).get();
                    if (userDoc.exists) {
                        const u = userDoc.data();
                        const updates = {};
                        if (!wData.userEmail && u.email) updates.userEmail = u.email;
                        if (!wData.userName && u.displayName) updates.userName = u.displayName;
                        if (!wData.phoneNumber && u.phoneNumber) updates.phoneNumber = u.phoneNumber;
                        if (!wData.phone && (wData.phoneNumber || u.phoneNumber)) updates.phone = wData.phoneNumber || u.phoneNumber;
                        if (!wData.referrerPhone && u.phoneNumber) updates.referrerPhone = u.phoneNumber;

                        if (Object.keys(updates).length > 0) {
                            await wDoc.ref.update(updates);
                            withdrawalsSynced++;
                        }
                    }
                }

                showToast(`Sync complete! Updated ${updatedCount} referrers and ${withdrawalsSynced} withdrawals.`, 'success');
                loadReferrals();
            } catch (e) {
                console.error('Sync error:', e);
                showToast('Error syncing data: ' + e.message, 'error');
            }
        }
    </script>
</body>

</html>