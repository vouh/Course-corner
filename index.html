<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="description" content="Course Corner offers a wide range of courses to help you achieve your educational and career goals. Explore now!">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="assets/js/firebase-config.js" type="module"></script>
    <script src="assets/js/calculator.js" type="module"></script>
    <script src="assets/js/courses-eligibility.js" type="module"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Corner - Calculate Your Cluster Points & Find Eligible Courses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/modern-ui.css">
    <link rel="icon" type="image/x-icon" href="assets/images/1.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/js/paymentHandler.js"></script>
    <link rel="stylesheet" href="assets/css/auth.css">
    <script src="assets/js/firebase-auth.js" defer></script>
    
    <!-- Custom Select for Mobile -->
    <script src="assets/js/custom-select.js" defer></script>
    
    <style>
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .blink-button {
            animation: blink 2s infinite;
            transition: all 0.3s ease;
        }

        .blink-button:hover {
            animation: none;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .pop-animation {
            animation: pop 0.3s ease-out;
        }

        /* Hero Image Styling */
        .hero-section {
            position: relative;
            height: 80vh;
            overflow: hidden;
        }

        .hero-image {
            width: 100%;
            height: 130%;
            object-fit:100%,100%;
        }
        .imagec{
            width: 100%;
            height: 100%;
            object-fit:contain;
        }

        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5));
        }

        /* Career Path Cards */
        .career-path-section {
            padding: 4rem 2rem;
            background: #f8f9fa;
        }


        .card-container {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .flip-card {
            width: 280px;
            height: 300px;
            perspective: 1000px;
            cursor: pointer;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .flip-card:hover .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .flip-card-front {
            background-color: white;
            color: #16a34a; 
        }

        .flip-card-back {
            background-color: #16a34a;
            color: white;
            transform: rotateY(180deg);
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .card-container {
                flex-direction: column;
                align-items: center;
            }

            .flip-card {
                width: 100%;
                max-width: 280px;
                margin-bottom: 1rem;
            }
        }

        @media (min-width: 768px) {
            #mobile-menu {
                background-color: #f8f9fa;
            }
        }

        body.loading {
            overflow: hidden;
            visibility: hidden;
        }

        body.loading #preloader {
            visibility: visible;
        }

        #preloader {
            position: fixed;
            inset: 0;
            background-color: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 loading">
    <!-- Preloader -->

    
    <div id="preloader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="text-center mb-4">
            <h2 class="text-3xl font-bold text-green-600 mb-2 animate-fade-in">Welcome to</h2>
            <h1 class="text-4xl font-bold text-green-600 animate-fade-in-delay">Course Corner</h1>
            <br>
            <p class="text-2xl  text-green-600 mb-2 animate-fade-in">Your career path starts here</p>
        </div>
        <div class="loader mt-4"></div>
    </div>

    <!-- Modern Sticky Navigation -->
    <header class="modern-header" id="mainHeader">
        <div class="header-container">
            <!-- Logo -->
            <a href="index.html" class="logo-container">
                <span class="logo-text">Course Corner</span>
            </a>

            <!-- Desktop Navigation -->
            <nav class="desktop-nav">
                <div class="nav-links">
                    <a href="index.html" class="modern-nav-link active">Home</a>
                    <a href="pages/about.html" class="modern-nav-link">About Us</a>
                    <a href="pages/cluster-points.html" class="modern-nav-link">Cluster Guide</a>
                    <a href="pages/application-process.html" class="modern-nav-link">Application</a>
                    <a href="pages/contact.html" class="modern-nav-link">Contact</a>
                </div>
                
                <!-- Auth Buttons -->
                <div class="nav-auth-buttons">
                    <div id="userAvatar" class="hidden"></div>
                    <button id="profileBtn" class="btn-nav-profile hidden" onclick="window.firebaseAuth.openProfileModal()">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </button>
                    <button id="authBtn" class="btn-nav-login" onclick="window.firebaseAuth.openAuthModal()">
                        <i class="fas fa-user"></i>
                        <span>Login</span>
                    </button>
                </div>
            </nav>

            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <nav class="mobile-nav-links">
                <a href="index.html" class="mobile-nav-link active">Home</a>
                <a href="pages/about.html" class="mobile-nav-link">About Us</a>
                <a href="pages/cluster-points.html" class="mobile-nav-link">Cluster Guide</a>
                <a href="pages/application-process.html" class="mobile-nav-link">Application</a>
                <a href="pages/contact.html" class="mobile-nav-link">Contact</a>
            </nav>
            <div class="mobile-auth-buttons">
                <button id="profileBtnMobile" class="btn-nav-profile hidden" style="width:100%; justify-content:center;" onclick="window.firebaseAuth.openProfileModal()">
                    <i class="fas fa-user-circle"></i>
                    Profile
                </button>
                <button id="authBtnMobile" class="btn-nav-login" style="width:100%; justify-content:center;" onclick="window.firebaseAuth.openAuthModal()">
                    <i class="fas fa-user"></i>
                    Login
                </button>
            </div>
        </div>
    </header>

    <!-- Modern Hero Section -->
    <section class="modern-hero">
        <!-- Background Pattern -->
        <div class="hero-bg-pattern"></div>
        
        <!-- Floating Shapes -->
        <div class="hero-shapes">
            <div class="hero-shape hero-shape-1"></div>
            <div class="hero-shape hero-shape-2"></div>
            <div class="hero-shape hero-shape-3"></div>
        </div>
        
        <!-- Hero Content -->
        <div class="hero-content">
            <div class="hero-badge">
                <i class="fas fa-star"></i>
                <span>Kenya's #1 Course Guidance Platform</span>
            </div>
            
            <h1 class="hero-title">
                Shape Your <span class="hero-title-highlight">Future</span> With Confidence
            </h1>
            
            <p class="hero-subtitle">
                Calculate your KCSE cluster points accurately and discover the perfect courses and universities for your career journey.
            </p>
            
            <div class="hero-cta-container" style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                <a href="pages/calculator.html" class="btn-hero-primary">
                    <i class="fas fa-calculator"></i>
                    Calculate Points
                </a>
                <a href="pages/cluster-points.html" class="btn-hero-secondary">
                    <i class="fas fa-book-open"></i>
                    Learn More
                </a>
            </div>
        </div>
    </section>

    <!-- Modern Features Section -->
    <section class="features-section">
        <div class="features-container">
            <div class="section-header">
                <h2 class="section-title">Your Path to Success</h2>
                <p class="section-subtitle">Four simple steps to discover your ideal career path and university placement</p>
            </div>
            
            <div class="features-grid">
                <!-- Feature Card 1 -->
                <div class="modern-feature-card" onclick="window.location.href='pages/calculator.html'">
                    <div class="feature-icon-wrapper">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h3 class="feature-title">Assess Grades</h3>
                    <p class="feature-description">Input your KCSE grades and calculate your cluster points accurately</p>
                </div>
                
                <!-- Feature Card 2 -->
                <div class="modern-feature-card">
                    <div class="feature-icon-wrapper">
                        <i class="fas fa-compass"></i>
                    </div>
                    <h3 class="feature-title">Explore Courses</h3>
                    <p class="feature-description">Discover courses that match your cluster points and interests</p>
                </div>
                
                <!-- Feature Card 3 -->
                <div class="modern-feature-card">
                    <div class="feature-icon-wrapper">
                        <i class="fas fa-university"></i>
                    </div>
                    <h3 class="feature-title">Find Universities</h3>
                    <p class="feature-description">Compare universities offering your chosen courses</p>
                </div>
                
                <!-- Feature Card 4 -->
                <div class="modern-feature-card">
                    <div class="feature-icon-wrapper">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="feature-title">Make Decision</h3>
                    <p class="feature-description">Choose your path with confidence and clarity</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Calculator CTA Section -->
    <section class="cta-section" id="calculator-cta">
        <div class="cta-container">
            <div class="cta-content">
                <div class="cta-badge">
                    <i class="fas fa-star"></i>
                    <span>Start Your Journey</span>
                </div>
                <h2 class="cta-title">Ready to Calculate Your <span class="highlight">Cluster Points?</span></h2>
                <p class="cta-description">
                    Input your KCSE grades and instantly discover your cluster points, eligible courses, and university options. 
                    Our comprehensive calculator covers all subject combinations and provides accurate results based on the latest KUCCPS guidelines.
                </p>
                <div class="cta-features">
                    <div class="cta-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Instant Results</span>
                    </div>
                    <div class="cta-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>All Subject Groups</span>
                    </div>
                    <div class="cta-feature">
                        <i class="fas fa-check-circle"></i>
                        <span>Course Recommendations</span>
                    </div>
                </div>
                <a href="pages/calculator.html" class="cta-button">
                    <i class="fas fa-calculator"></i>
                    Open Calculator
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            <div class="cta-visual">
                <div class="cta-card">
                    <div class="cta-card-header">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Sample Result</span>
                    </div>
                    <div class="cta-card-body">
                        <div class="cta-score">
                            <span class="score-number">72</span>
                            <span class="score-label">/ 84 Points</span>
                        </div>
                        <div class="cta-courses">
                            <div class="course-tag">Medicine</div>
                            <div class="course-tag">Engineering</div>
                            <div class="course-tag">Law</div>
                            <div class="course-tag">+50 more</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Modern Header Scroll Effect
            const header = document.getElementById('mainHeader');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
            
            // Mobile menu toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            mobileMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenuBtn.classList.toggle('active');
                mobileMenu.classList.toggle('show');
            });
            
            // Close mobile menu when clicking a link
            mobileMenu.querySelectorAll('a, button').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.remove('show');
                    mobileMenuBtn.classList.remove('active');
                });
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    mobileMenu.classList.remove('show');
                    mobileMenuBtn.classList.remove('active');
                }
            });

            // Close mobile menu when window is resized to desktop size
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    mobileMenu.classList.remove('show');
                    mobileMenuBtn.classList.remove('active');
                }
            });
            
            // Update score display when grades change
            document.querySelectorAll('.modern-grade-select, .grade-select').forEach(select => {
                select.addEventListener('change', function() {
                    // Add visual feedback when a grade is selected
                    if (this.value) {
                        this.classList.add('has-value');
                    } else {
                        this.classList.remove('has-value');
                    }
                    // Update the overall grade display
                    updateOverallGradeDisplay();
                });
            });
            
            function updateOverallGradeDisplay() {
                const overallGrade = document.getElementById('overallGrade');
                const display = document.getElementById('overallGradeDisplay');
                if (overallGrade && display) {
                    display.textContent = overallGrade.value || '0';
                }
            }
        });
    </script>

    <!-- Footer -->
    <footer class="modern-footer">
        <div class="footer-container">
            <div class="footer-grid">
                <!-- Brand -->
                <div class="footer-col">
                    <div class="footer-brand">
                        <span>Course Corner</span>
                    </div>
                    <p class="footer-description">
                        Empowering students to make informed decisions about their educational future through personalized course recommendations.
                    </p>
                    <div class="social-links">
                        <a href="#" target="_blank"><i class="fab fa-tiktok"></i></a>
                        <a href="#" target="_blank"><i class="fab fa-whatsapp"></i></a>
                        <a href="#" target="_blank"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="footer-col">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="pages/calculator.html">Calculator</a></li>
                        <li><a href="pages/cluster-points.html">Cluster Points Guide</a></li>
                        <li><a href="pages/application-process.html">Application Process</a></li>
                    </ul>
                </div>

                <!-- Resources -->
                <div class="footer-col">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="#">KUCCPS Guide 2024</a></li>
                        <li><a href="#">Course Requirements</a></li>
                        <li><a href="#">Application Forms</a></li>
                    </ul>
                </div>

                <!-- Contact Us -->
                <div class="footer-col">
                    <h4>Contact Us</h4>
                    <ul>
                        <li><i class="fas fa-envelope"></i> info@coursecorner.com</li>
                        <li><i class="fas fa-phone"></i> +254 700 000000</li>
                    </ul>
                </div>
            </div>

            <!-- Copyright -->
            <div class="footer-bottom">
                <p>© Course Corner <span id="currentYear"></span>. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Update copyright year
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>

    <!-- Preloader -->
    <script>
        window.addEventListener('load', function() {
            const preloader = document.getElementById('preloader');
            const body = document.body;
            
            setTimeout(() => {
                body.classList.remove('loading');
                preloader.classList.add('fade-out');
                setTimeout(() => {
                    preloader.style.display = 'none';
                }, 500);
            }, 10);
        });
    </script>

    <!-- Reveal on scroll -->
    <script>
        const observerOptions = {
            root: null,
            threshold: 0.1,
            rootMargin: "0px"
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('reveal-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        // Add reveal class to elements you want to animate
        document.querySelectorAll('.reveal').forEach((element) => {
            observer.observe(element);
        });
    </script>

    <script>
        // Add event listeners to all grade selects
        document.querySelectorAll('.grade-select').forEach(select => {
            select.addEventListener('change', calculateTotalPoints);
        });

        function calculateTotalPoints() {
            let total = 0;
            const scores = {};
            
            // Get all selected grades
            document.querySelectorAll('.grade-select').forEach(select => {
                if (select.value) {
                    scores[select.id] = parseInt(select.value);
                }
            });

            // Count total subjects selected
            const totalSubjectsSelected = Object.keys(scores).length;

            // Reset the input field if less than 7 subjects
            if (totalSubjectsSelected < 7) {
                document.getElementById('overallGrade').value = "";
                return;
            }

            // 1. Mathematics (compulsory)
            if (!scores.mathematics) {
                document.getElementById('overallGrade').value = "";
                return;
            }
            total += scores.mathematics;

            // 2. Find best performing language
            const languages = ['english', 'kiswahili', 'french', 'german', 'arabic', 'signLanguage'];
            const languageScores = languages
                .filter(lang => scores[lang])
                .map(lang => ({ subject: lang, score: scores[lang] }));
            
            if (languageScores.length === 0) {
                document.getElementById('overallGrade').value = "";
                return;
            }

            const bestLanguage = languageScores.reduce((best, current) => 
                current.score > best.score ? current : best
            );
            total += bestLanguage.score;

            // 3. Get all remaining subjects (excluding mathematics and best language)
            const remainingSubjects = Object.entries(scores)
                .filter(([subject]) => 
                    subject !== 'mathematics' && 
                    subject !== bestLanguage.subject
                )
                .map(([subject, score]) => ({ subject, score }))
                .sort((a, b) => b.score - a.score); // Sort by score descending

            // 4. Take the best 5 remaining subjects
            const bestFiveRemaining = remainingSubjects.slice(0, 5);
            bestFiveRemaining.forEach(subject => {
                total += subject.score;
            });

            // Update the overallGrade input
            document.getElementById('overallGrade').value = total;

            // Remove this line to prevent automatic showing of results
            // document.getElementById('results').classList.remove('hidden');
        }

        // Old button listeners removed - Payment is now required first
    </script>

    <!-- Add this script after the existing scripts -->
    <script>
        // Make the grade function globally available
        function get_grade_from_points(points) {
            if (points >= 81) return "A"
            else if (points >= 74) return "A-"
            else if (points >= 67) return "B+"
            else if (points >= 60) return "B"
            else if (points >= 53) return "B-" 
            else if (points >= 46) return "C+"
            else if (points >= 39) return "C"
            else if (points >= 32) return "C-"
            else if (points >= 25) return "D+"
            else if (points >= 18) return "D"
            else if (points >= 11) return "D-"
            else return "E"
        }

        // Then your existing initializeDownloadButton function
        function initializeDownloadButton() {
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', async function() {
                    try {
                        // Prompt for student name
                        const studentName = await Swal.fire({
                            title: 'Enter your name',
                            input: 'text',
                            inputLabel: 'Your name will appear on the PDF report',
                            inputPlaceholder: 'Enter your full name',
                            showCancelButton: true,
                            inputValidator: (value) => {
                                if (!value) {
                                    return 'Please enter your name!';
                                }
                            }
                        });

                        if (studentName.isConfirmed) {
                            // Get student info
                            const studentPoints = parseInt(document.getElementById('overallGrade').value);
                            const grade = get_grade_from_points(studentPoints);

                            // Initialize jsPDF
                            const doc = new jspdf.jsPDF();
                            const pageWidth = doc.internal.pageSize.getWidth();
                            const pageHeight = doc.internal.pageSize.getHeight();

                            // Add watermark
                            doc.setTextColor(230, 230, 230);
                            doc.setFontSize(60);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Course Corner', pageWidth/2, pageHeight/2, {
                                align: 'center',
                                angle: 45
                            });

                            // Add green header banner
                            doc.setFillColor(34, 197, 94);
                            doc.rect(0, 0, pageWidth, 20, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(16);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Course Corner', pageWidth/2, 13, { align: 'center' });

                            // Add student info section with border
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineWidth(0.5);
                            doc.rect(10, 25, pageWidth - 20, 25);
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(12);
                            doc.text(`Student Name: ${studentName.value}`, 15, 35);
                            doc.text(`Total Points: ${studentPoints}`, 15, 42);
                            doc.text(`Overall Grade: ${grade}`, pageWidth/2, 42);

                            // Cluster Points Section with pink theme
                            let yPos = 60;
                            doc.setFillColor(249, 168, 212); // Pink background
                            doc.rect(10, yPos, pageWidth - 20, 15, 'F');
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(14);
                            doc.setFont('helvetica', 'bold');
                            doc.text('Cluster Points', 15, yPos + 10);
                            yPos += 20;

                            // Add cluster points with consistent formatting
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(10);
                            const clusterPoints = window.lastClusterPoints;
                            if (clusterPoints) {
                                Object.entries(clusterPoints).forEach(([clusterName, points]) => {
                                    const clusterNumber = clusterName.split(' ')[1];
                                    doc.text(`cluster ${clusterNumber} - ${points.toFixed(4)}`, 15, yPos);
                                    yPos += 7;
                                });
                            }

                            // Add divider
                            yPos += 10;
                            doc.setDrawColor(200, 200, 200);
                            doc.line(10, yPos, pageWidth - 10, yPos);
                            yPos += 15;

                            // Courses Section with colored sections
                            const sections = document.querySelectorAll('.collapsible-header');
                            if (sections && sections.length > 0) {
                                sections.forEach((section, index) => {
                                    // Set color based on section type
                                    let sectionColor;
                                    const title = section.querySelector('h3')?.textContent || '';
                                    if (title.includes('Degree')) {
                                        sectionColor = [34, 197, 94]; // Green
                                    } else if (title.includes('Diploma')) {
                                        sectionColor = [59, 130, 246]; // Blue
                                    } else if (title.includes('Certificate')) {
                                        sectionColor = [139, 92, 246]; // Purple
                                    } else {
                                        sectionColor = [249, 115, 22]; // Orange
                                    }

                                    // Section header with color
                                    doc.setFillColor(...sectionColor);
                                    doc.rect(10, yPos, pageWidth - 20, 10, 'F');
                                    doc.setTextColor(255, 255, 255);
                                    doc.setFontSize(12);
                                    doc.setFont('helvetica', 'bold');
                                    doc.text(title, 15, yPos + 7);
                                    yPos += 15;

                                    // Course listings in table format
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFontSize(10);
                                    doc.setFont('helvetica', 'normal');

                                    const coursesList = section.nextElementSibling?.querySelectorAll('li') || [];
                                    coursesList.forEach(course => {
                                        if (yPos >= pageHeight - 20) {
                                            doc.addPage();
                                            yPos = 20;
                                        }
                                        doc.text('✓', 15, yPos);
                                        doc.text(course.textContent.trim(), 25, yPos);
                                        yPos += 7;
                                    });

                                    yPos += 10;
                                });
                            }

                            // Add footer
                            doc.setTextColor(128, 128, 128);
                            doc.setFontSize(8);
                            doc.text('© Course Corner 2025', pageWidth/2, pageHeight - 10, { align: 'center' });

                            // Save the PDF
                            const fileName = `${studentName.value.replace(/\s+/g, '_')}_report.pdf`;
                            doc.save(fileName);

                            // Show success message with confirmation button
                            Swal.fire({
                                icon: 'success',
                                title: 'PDF Generated!',
                                text: 'Your complete report has been downloaded.',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#16a34a',  // Green color to match your theme
                                allowOutsideClick: true,
                                showConfirmButton: true
                            });
                        }
                    } catch (error) {
                        console.error('PDF generation error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message || 'Failed to generate PDF. Please try again.'
                        });
                    }
                });
            }
        }
    </script>

    <!-- Add this script right before the closing </body> tag -->
    <script>
        async function handleDownload() {
            try {
                // First check if points are calculated
                const overallGrade = document.getElementById('overallGrade');
                if (!overallGrade || !overallGrade.value) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Please calculate your cluster points first'
                    });
                    return;
                }

                const resultsDiv = document.getElementById('results');
                if (!resultsDiv) {
                    throw new Error('Results section not found');
                }

                // Get student name
                const studentName = await Swal.fire({
                    title: 'Enter your name',
                    input: 'text',
                    inputLabel: 'Your name will appear on the PDF report',
                    inputPlaceholder: 'Enter your full name',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Please enter your name!';
                        }
                    }
                });

                if (studentName.isConfirmed) {
                    // Show loading
                    const loadingAlert = Swal.fire({
                        title: 'Generating PDF',
                        text: 'Please wait...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Expand all sections
                    const collapsibles = document.querySelectorAll('.collapsible-content');
                    collapsibles.forEach(content => content.classList.remove('hidden'));

                    // Create PDF
                    const doc = new jspdf.jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();

                    // Add watermark
                    doc.setTextColor(230, 230, 230);
                    doc.setFontSize(60);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Course Corner', pageWidth/2, pageHeight/2, {
                        align: 'center',
                        angle: 45
                    });

                    // Add green header banner
                    doc.setFillColor(34, 197, 94);
                    doc.rect(0, 0, pageWidth, 20, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Course Corner', pageWidth/2, 13, { align: 'center' });

                    // Add student info section with border
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(10, 25, pageWidth - 20, 25);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.text(`Student Name: ${studentName.value}`, 15, 35);
                    doc.text(`Total Points: ${overallGrade.value}`, 15, 42);
                    doc.text(`Overall Grade: ${get_grade_from_points(parseInt(overallGrade.value))}`, pageWidth/2, 42);

                    // Cluster Points Section with pink theme
                    let yPos = 60;
                    doc.setFillColor(249, 168, 212); // Pink background
                    doc.rect(10, yPos, pageWidth - 20, 15, 'F');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Cluster Points', 15, yPos + 10);
                    yPos += 20;

                    // Add cluster points with consistent formatting
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const clusterPoints = window.lastClusterPoints;
                    if (clusterPoints) {
                        Object.entries(clusterPoints).forEach(([clusterName, points]) => {
                            const clusterNumber = clusterName.split(' ')[1];
                            doc.text(`cluster ${clusterNumber} - ${points.toFixed(4)}`, 15, yPos);
                            yPos += 7;
                        });
                    }

                    // Add divider
                    yPos += 10;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(10, yPos, pageWidth - 10, yPos);
                    yPos += 15;

                    // Courses Section with colored sections
                    const sections = document.querySelectorAll('.collapsible-header');
                    if (sections && sections.length > 0) {
                        sections.forEach((section, index) => {
                            // Set color based on section type
                            let sectionColor;
                            const title = section.querySelector('h3')?.textContent || '';
                            if (title.includes('Degree')) {
                                sectionColor = [34, 197, 94]; // Green
                            } else if (title.includes('Diploma')) {
                                sectionColor = [59, 130, 246]; // Blue
                            } else if (title.includes('Certificate')) {
                                sectionColor = [139, 92, 246]; // Purple
                            } else {
                                sectionColor = [249, 115, 22]; // Orange
                            }

                            // Section header with color
                            doc.setFillColor(...sectionColor);
                            doc.rect(10, yPos, pageWidth - 20, 10, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text(title, 15, yPos + 7);
                            yPos += 15;

                            // Course listings in table format
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');

                            const coursesList = section.nextElementSibling?.querySelectorAll('li') || [];
                            coursesList.forEach(course => {
                                if (yPos >= pageHeight - 20) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                doc.text('✓', 15, yPos);
                                doc.text(course.textContent.trim(), 25, yPos);
                                yPos += 7;
                            });

                            yPos += 10;
                        });
                    }

                    // Add footer
                    doc.setTextColor(128, 128, 128);
                    doc.setFontSize(8);
                    doc.text('© Course Corner 2025', pageWidth/2, pageHeight - 10, { align: 'center' });

                    // Save the PDF
                    const fileName = `${studentName.value.replace(/\s+/g, '_')}_report.pdf`;
                    doc.save(fileName);

                    // Close loading alert before showing success message
                    await loadingAlert.close();

                    // Show success message with confirmation button
                    Swal.fire({
                        icon: 'success',
                        title: 'PDF Generated!',
                        text: 'Your complete report has been downloaded.',
                        confirmButtonText: 'OK',
                        confirmButtonColor: '#16a34a',  // Green color to match your theme
                        allowOutsideClick: true,
                        showConfirmButton: true
                    });
                }
            } catch (error) {
                console.error('PDF generation error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to generate PDF. Please try again.'
                });
            }
        }

        // Add click handler to the third button
        document.getElementById('calculateBtn3').addEventListener('click', function() {
            setTimeout(() => {
                const downloadBtn = document.getElementById('downloadBtn');
                if (downloadBtn) {
                    downloadBtn.removeEventListener('click', handleDownload);
                    downloadBtn.addEventListener('click', handleDownload);
                }
            }, 1000);
        });
    </script>

    <!-- Add this new function for handling courses-only download -->
    <script>
        async function handleCoursesOnlyDownload() {
            try {
                // Get student name
                const studentName = await Swal.fire({
                    title: 'Enter your name',
                    input: 'text',
                    inputLabel: 'Your name will appear on the PDF report',
                    inputPlaceholder: 'Enter your full name',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Please enter your name!';
                        }
                    }
                });

                if (studentName.isConfirmed) {
                    // Show loading
                    const loadingAlert = Swal.fire({
                        title: 'Generating PDF',
                        text: 'Please wait...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Create PDF
                    const doc = new jspdf.jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();

                    // Add watermark
                    doc.setTextColor(230, 230, 230);
                    doc.setFontSize(60);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Course Corner', pageWidth/2, pageHeight/2, {
                        align: 'center',
                        angle: 90
                    });

                    // Add green header banner
                    doc.setFillColor(34, 197, 94);
                    doc.rect(0, 0, pageWidth, 20, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Course Corner', pageWidth/2, 13, { align: 'center' });

                    // Add student info section with border
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(10, 25, pageWidth - 20, 25);
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.text(`Student Name: ${studentName.value}`, 15, 35);
                    doc.text('Courses Report', 15, 42);

                    let yPos = 60;

                    // Courses Section with colored sections
                    const sections = document.querySelectorAll('.collapsible-header');
                    if (sections && sections.length > 0) {
                        sections.forEach((section, index) => {
                            // Set color based on section type
                            let sectionColor;
                            const title = section.querySelector('h3')?.textContent || '';
                            if (title.includes('Degree')) {
                                sectionColor = [34, 197, 94]; // Green
                            } else if (title.includes('Diploma')) {
                                sectionColor = [59, 130, 246]; // Blue
                            } else if (title.includes('Certificate')) {
                                sectionColor = [139, 92, 246]; // Purple
                            } else {
                                sectionColor = [249, 115, 22]; // Orange
                            }

                            // Section header with color
                            doc.setFillColor(...sectionColor);
                            doc.rect(10, yPos, pageWidth - 20, 10, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text(title, 15, yPos + 7);
                            yPos += 15;

                            // Course listings
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');

                            const coursesList = section.nextElementSibling?.querySelectorAll('li') || [];
                            coursesList.forEach(course => {
                                if (yPos >= pageHeight - 20) {
                                    doc.addPage();
                                    yPos = 20;
                                }
                                doc.text('✓', 15, yPos);
                                doc.text(course.textContent.trim(), 25, yPos);
                                yPos += 7;
                            });

                            yPos += 10;
                        });
                    }

                    // Add footer
                    doc.setTextColor(128, 128, 128);
                    doc.setFontSize(8);
                    doc.text('© Course Corner 2025', pageWidth/2, pageHeight - 10, { align: 'center' });

                    // Save the PDF
                    const fileName = `${studentName.value.replace(/\s+/g, '_')}_courses.pdf`;
                    doc.save(fileName);

                    // Close loading alert and show success message
                    loadingAlert.close();
                    
                    setTimeout(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'PDF Generated!',
                            text: 'Your courses report has been downloaded.',
                            confirmButtonText: 'OK',
                            confirmButtonColor: '#16a34a',
                            allowOutsideClick: true,
                            showConfirmButton: true,
                            didOpen: () => {
                                Swal.hideLoading();
                            }
                        });
                    }, 100);
                }
            } catch (error) {
                console.error('PDF generation error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to generate PDF. Please try again.'
                });
            }
        }
    </script>

    <!-- Payment Button Handlers - Unified Payment Flow -->
    <script>
        // ===== UNIFIED PAYMENT FLOW =====
        // All payment logic is centralized here to prevent duplicate handlers
        
        // Clear any existing payment handlers from courses-eligibility.js
        window.PAYMENT_HANDLERS_INITIALIZED = true;
        
        // Initialize Payment Handler with your server URL
        // Server is hosted on Vercel
        const SERVER_URL = 'https://course-corner-server.vercel.app/api';

        // Create single payment handler instance
        if (!window.paymentHandler) {
            window.paymentHandler = new PaymentHandler(SERVER_URL);
        }

        // Validate student subjects before payment
        function validateSubjects() {
            const errors = [];
            
            // Check compulsory subjects
            const english = document.getElementById('english')?.value;
            const kiswahili = document.getElementById('kiswahili')?.value;
            const mathematics = document.getElementById('mathematics')?.value;
            
            if (!english) errors.push('English');
            if (!kiswahili) errors.push('Kiswahili');
            if (!mathematics) errors.push('Mathematics');
            
            // Count total subjects selected
            let totalSubjects = 0;
            document.querySelectorAll('.grade-select').forEach(select => {
                if (select.value) totalSubjects++;
            });
            
            return {
                valid: errors.length === 0 && totalSubjects >= 7,
                missingCompulsory: errors,
                totalSubjects: totalSubjects,
                needMore: Math.max(0, 7 - totalSubjects)
            };
        }

        // Main payment processing function
        async function processPayment(category, amount) {
            const grades = getStudentGrades ? getStudentGrades() : {};
            const overallGrade = document.getElementById('overallGrade').value;
            
            // Validate subjects before showing payment window
            const validation = validateSubjects();
            
            if (!validation.valid) {
                let errorHtml = '<div class="text-left">';
                
                if (validation.missingCompulsory.length > 0) {
                    errorHtml += `<p class="mb-2"><strong>Missing compulsory subjects:</strong></p>`;
                    errorHtml += `<ul class="list-disc list-inside mb-3 text-red-600">`;
                    validation.missingCompulsory.forEach(subj => {
                        errorHtml += `<li>${subj}</li>`;
                    });
                    errorHtml += `</ul>`;
                }
                
                if (validation.needMore > 0) {
                    errorHtml += `<p class="text-gray-600">You need <strong>${validation.needMore} more subject(s)</strong> (minimum 7 required).</p>`;
                    errorHtml += `<p class="text-sm text-gray-500 mt-2">Currently selected: ${validation.totalSubjects} subjects</p>`;
                }
                
                errorHtml += '</div>';
                
                Swal.fire({
                    icon: 'warning',
                    title: 'Please Complete Your Grades',
                    html: errorHtml,
                    confirmButtonColor: '#16a34a',
                    confirmButtonText: 'Fill Grades'
                });
                
                // Scroll to the grades section
                document.getElementById('calculator')?.scrollIntoView({ behavior: 'smooth' });
                return false;
            }

            // Get phone number from user
            const { value: phoneNumber } = await Swal.fire({
                title: 'M-Pesa Payment',
                html: `
                    <div class="text-left mb-4">
                        <p class="text-gray-600 mb-2">Service: <strong>${getCategoryName(category)}</strong></p>
                        <p class="text-gray-600">Amount: <strong class="text-green-600">KSH ${amount}</strong></p>
                    </div>
                `,
                input: 'text',
                inputLabel: 'Enter your M-Pesa phone number',
                inputPlaceholder: '0712345678 or 254712345678',
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Pay Now',
                confirmButtonColor: '#16a34a',
                cancelButtonText: 'Cancel',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Phone number is required!';
                    }
                    if (!/\d{9,}/.test(value.replace(/[^\d]/g, ''))) {
                        return 'Please enter a valid phone number';
                    }
                }
            });

            if (!phoneNumber) return false; // User cancelled

            try {
                // Show payment processing message
                Swal.fire({
                    title: 'Initiating Payment...',
                    html: `
                        <p class="mb-2">Amount: <strong>KSH ${amount}</strong></p>
                        <p>Phone: <strong>${phoneNumber}</strong></p>
                        <p class="mt-4 text-sm text-gray-500">Sending STK push to your phone...</p>
                    `,
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                // Initiate payment
                await window.paymentHandler.initiatePayment(phoneNumber, category);

                // Show payment status and start polling immediately
                const paymentStatusDiv = document.getElementById('paymentStatus');
                const paymentMessage = document.getElementById('paymentMessage');
                paymentStatusDiv.classList.remove('hidden');
                paymentMessage.textContent = 'Waiting for M-Pesa confirmation...';

                // Show waiting for M-Pesa with real-time status updates (no button click required)
                let paymentCancelled = false;
                Swal.fire({
                    title: '📱 Check Your Phone!',
                    html: `
                        <div class="text-center">
                            <p class="mb-3">An M-Pesa prompt has been sent to:</p>
                            <p class="text-xl font-bold text-green-600 mb-4">${phoneNumber}</p>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 text-left">
                                <p class="text-sm text-yellow-800">
                                    <strong>Enter your M-Pesa PIN</strong> on your phone to complete the payment.
                                </p>
                            </div>
                            <div id="swal-status-container" class="mt-4 p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center justify-center mb-2">
                                    <span class="inline-block w-3 h-3 bg-yellow-500 rounded-full animate-pulse mr-2"></span>
                                    <span id="swal-status-text" class="text-sm font-medium text-gray-700">Waiting for your PIN entry...</span>
                                </div>
                                <p id="swal-attempt-text" class="text-xs text-gray-400">Listening for M-Pesa response...</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-3">Click Cancel if you didn't receive the prompt</p>
                        </div>
                    `,
                    allowOutsideClick: true,
                    allowEscapeKey: true,
                    showConfirmButton: false,
                    showCancelButton: true,
                    cancelButtonText: 'Cancel',
                    cancelButtonColor: '#6b7280',
                    didOpen: () => Swal.showLoading()
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.cancel) {
                        paymentCancelled = true;
                    }
                });

                // Wait for payment with status callback (starts immediately, no button click needed)
                await window.paymentHandler.pollPaymentStatus(40, 3000, (status, attempt, maxAttempts) => {
                    const statusText = document.getElementById('swal-status-text');
                    const attemptText = document.getElementById('swal-attempt-text');
                    if (statusText) {
                        if (status === 'pending') {
                            statusText.textContent = 'Waiting for M-Pesa confirmation...';
                        } else if (status === 'completed') {
                            statusText.textContent = 'Payment confirmed! ✅';
                        } else if (status === 'failed') {
                            statusText.textContent = 'Payment failed ❌';
                        }
                    }
                    if (attemptText) {
                        const timeRemaining = Math.max(0, (maxAttempts - attempt) * 3);
                        attemptText.textContent = `Checking... ${attempt}/${maxAttempts} • Timeout in ~${timeRemaining}s`;
                    }
                });

                // Check if cancelled
                if (paymentCancelled) {
                    window.paymentHandler.clearSession();
                    return false;
                }

                // Payment successful - approve access
                await window.paymentHandler.approveAccess();

                // Hide payment status
                paymentStatusDiv.classList.add('hidden');

                // Show brief success message then auto-redirect to results
                Swal.fire({
                    icon: 'success',
                    title: 'Payment Successful! ✅',
                    html: `<p class="text-green-600 mb-2">Your payment has been confirmed!</p>`,
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });

                // Auto-show results after brief delay
                setTimeout(() => {
                    showResultsAfterPayment(category);
                    
                    // Scroll to results section
                    document.getElementById('results')?.scrollIntoView({ behavior: 'smooth' });
                }, 1600);

                return true; // Payment successful

            } catch (error) {
                document.getElementById('paymentStatus').classList.add('hidden');
                
                // Determine icon and title based on error message
                let icon = 'error';
                let title = 'Payment Failed';
                const errorMsg = error.message || 'An error occurred during payment verification';
                
                if (errorMsg.toLowerCase().includes('cancel')) {
                    icon = 'warning';
                    title = 'Payment Cancelled';
                } else if (errorMsg.toLowerCase().includes('pin') || errorMsg.toLowerCase().includes('wrong')) {
                    icon = 'error';
                    title = 'Wrong PIN';
                } else if (errorMsg.toLowerCase().includes('insufficient') || errorMsg.toLowerCase().includes('balance')) {
                    icon = 'warning';
                    title = 'Insufficient Balance';
                } else if (errorMsg.toLowerCase().includes('timeout') || errorMsg.toLowerCase().includes('timed out')) {
                    icon = 'info';
                    title = 'Request Timed Out';
                }
                
                Swal.fire({
                    icon: icon,
                    title: title,
                    html: `
                        <p class="mb-3">${errorMsg}</p>
                        <p class="text-sm text-gray-500">You can try again by clicking the button.</p>
                    `,
                    confirmButtonText: 'Try Again',
                    confirmButtonColor: '#16a34a'
                });
                
                window.paymentHandler.clearSession();
                return false;
            }
        }

        // Helper function to get category display name
        function getCategoryName(category) {
            const names = {
                'calculate-cluster-points': 'Cluster Points Calculation',
                'courses-only': 'Eligible Courses',
                'point-and-courses': 'Cluster Points & Courses'
            };
            return names[category] || category;
        }

        // Handle calculate results after payment
        function showResultsAfterPayment(category) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('hidden');

            if (category === 'calculate-cluster-points') {
                // Calculate and show cluster points only
                if (typeof calculateClusterPoints === 'function') {
                    calculateClusterPoints();
                }
            } else if (category === 'courses-only') {
                // Show eligible courses only
                if (typeof getStudentGrades === 'function' && typeof getEligibleCourses === 'function') {
                    const grades = getStudentGrades();
                    const eligibleCourses = getEligibleCourses(grades);
                    if (typeof displayAllResults === 'function') {
                        displayAllResults(eligibleCourses);
                    }
                }
            } else if (category === 'point-and-courses') {
                // Show both cluster points and courses
                if (typeof calculateClusterPoints === 'function') {
                    calculateClusterPoints();
                }
                if (typeof getStudentGrades === 'function' && typeof getEligibleCourses === 'function') {
                    const grades = getStudentGrades();
                    const eligibleCourses = getEligibleCourses(grades);
                    if (typeof displayCombinedResults === 'function') {
                        displayCombinedResults(eligibleCourses);
                    }
                }
            }

            // Scroll to results
            setTimeout(() => {
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        // Initialize payment button handlers on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // Remove any previous handlers and add unified ones
            const paymentBtns = document.querySelectorAll('.payment-btn');
            
            paymentBtns.forEach(btn => {
                // Clone to remove old handlers
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const category = this.getAttribute('data-category');
                    const amount = this.getAttribute('data-amount');
                    
                    console.log('Payment button clicked:', category, amount);
                    
                    // Process payment first
                    const paymentSuccess = await processPayment(category, amount);
                    
                    // Only show results if payment was successful
                    if (paymentSuccess) {
                        showResultsAfterPayment(category);
                    }
                });
            });
            
            console.log('Unified payment handlers initialized for', paymentBtns.length, 'buttons');
        });

        // Check if user already has paid access on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const sessionId = localStorage.getItem('paymentSessionId');
            if (sessionId) {
                try {
                    const access = await window.paymentHandler.hasAccessToCategory();
                    if (access.hasAccess) {
                        console.log('User has existing paid access');
                    }
                } catch (error) {
                    console.log('Access check skipped:', error.message);
                }
            }
        });
    </script>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal-overlay hidden">
        <div class="auth-modal">
            <div class="modal-header">
                <h2>Welcome to Course Corner</h2>
                <button class="modal-close-btn" onclick="window.firebaseAuth.closeAuthModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Auth Tabs -->
                <div class="auth-tabs">
                    <button id="loginTab" class="auth-tab active" onclick="window.firebaseAuth.switchAuthMode('login')">
                        Login
                    </button>
                    <button id="signupTab" class="auth-tab" onclick="window.firebaseAuth.switchAuthMode('signup')">
                        Sign Up
                    </button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                    </div>
                    <div class="forgot-password-link">
                        <a class="auth-link text-sm" onclick="window.firebaseAuth.switchAuthMode('forgot')">Forgot password?</a>
                    </div>
                    <button type="submit" id="loginBtn" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        Login
                    </button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" class="auth-form hidden" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label for="signupName">Full Name</label>
                        <input type="text" id="signupName" class="form-input" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" class="form-input" placeholder="Create a password (min 6 characters)" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="signupConfirmPassword">Confirm Password</label>
                        <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" id="signupBtn" class="btn-primary">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </form>

                <!-- Forgot Password Section -->
                <div id="forgotPasswordSection" class="auth-form hidden">
                    <p class="text-gray-600 mb-4">Enter your email address and we'll send you a link to reset your password.</p>
                    <div class="form-group">
                        <label for="resetEmail">Email Address</label>
                        <input type="email" id="resetEmail" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <button type="button" onclick="handleResetPassword()" class="btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        Send Reset Link
                    </button>
                    <div class="text-center mt-4">
                        <a class="auth-link" onclick="window.firebaseAuth.switchAuthMode('login')">
                            <i class="fas fa-arrow-left mr-1"></i>
                            Back to Login
                        </a>
                    </div>
                </div>

                <!-- Divider -->
                <div class="auth-divider">
                    <span>or continue with</span>
                </div>

                <!-- Google Sign In -->
                <button type="button" onclick="handleGoogleSignIn()" class="btn-google">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    Sign in with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="auth-modal-overlay hidden">
        <div class="auth-modal profile-modal">
            <div class="modal-header">
                <h2>My Profile</h2>
                <button class="modal-close-btn" onclick="window.firebaseAuth.closeProfileModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- User Info Display -->
                <div id="userInfoDisplay" class="user-info-display">
                    <div id="userAvatarLarge" class="user-avatar-large">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="userDisplayName">User</h3>
                    </div>
                </div>

                <!-- Personal Information Section -->
                <div class="profile-section">
                    <h3 class="profile-section-title">
                        <i class="fas fa-user mr-2"></i>Personal Information
                    </h3>
                    <div class="form-group mb-3">
                        <label for="profileEmail">Email Address</label>
                        <input type="email" id="profileEmail" class="form-input bg-gray-100" readonly>
                    </div>
                    <div class="form-group mb-3">
                        <label for="profilePhone">Phone Number</label>
                        <input type="tel" id="profilePhone" class="form-input" placeholder="e.g., 0712345678">
                    </div>
                </div>

                <!-- KCSE Information Section -->
                <div class="profile-section">
                    <h3 class="profile-section-title">
                        <i class="fas fa-graduation-cap mr-2"></i>KCSE Information
                    </h3>
                    <div class="form-group mb-4">
                        <label for="profileKcseYear">KCSE Year</label>
                        <select id="profileKcseYear" class="form-select">
                            <option value="">Select Year</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                            <option value="2016">2016</option>
                            <option value="2015">2015</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- KCSE Grades Section -->
                <div class="profile-section">
                    <h3 class="profile-section-title">
                        <i class="fas fa-chart-bar mr-2"></i>KCSE Grades
                    </h3>
                    <p class="text-sm text-gray-600 mb-3">Save your grades to auto-fill the cluster calculator</p>
                    <div class="grades-grid">
                        <!-- Core Subjects -->
                        <div class="form-group">
                            <label for="profile_mathematics">Mathematics</label>
                            <select id="profile_mathematics" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_english">English</label>
                            <select id="profile_english" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_kiswahili">Kiswahili</label>
                            <select id="profile_kiswahili" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <!-- Sciences -->
                        <div class="form-group">
                            <label for="profile_biology">Biology</label>
                            <select id="profile_biology" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_chemistry">Chemistry</label>
                            <select id="profile_chemistry" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_physics">Physics</label>
                            <select id="profile_physics" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <!-- Humanities -->
                        <div class="form-group">
                            <label for="profile_history">History</label>
                            <select id="profile_history" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_geography">Geography</label>
                            <select id="profile_geography" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_cre">CRE/IRE/HRE</label>
                            <select id="profile_cre" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <!-- Technical/Applied -->
                        <div class="form-group">
                            <label for="profile_agriculture">Agriculture</label>
                            <select id="profile_agriculture" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_business">Business Studies</label>
                            <select id="profile_business" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profile_computer">Computer Studies</label>
                            <select id="profile_computer" class="form-select">
                                <option value="">Select</option>
                                <option value="A">A</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="B-">B-</option>
                                <option value="C+">C+</option>
                                <option value="C">C</option>
                                <option value="C-">C-</option>
                                <option value="D+">D+</option>
                                <option value="D">D</option>
                                <option value="D-">D-</option>
                                <option value="E">E</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="window.firebaseAuth.closeProfileModal()" class="btn-secondary flex-1">
                        Cancel
                    </button>
                    <button type="button" onclick="handleSaveProfile()" id="saveProfileBtn" class="btn-primary flex-1">
                        <i class="fas fa-save mr-2"></i>
                        Save Changes
                    </button>
                </div>

                <!-- Logout Button -->
                <div class="mt-4 pt-4 border-t">
                    <button type="button" onclick="handleLogout()" class="btn-secondary w-full text-red-600 border-red-200 hover:bg-red-50">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Form Handlers Script -->
    <script>
        // Login handler
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            const result = await window.firebaseAuth.signIn(email, password);
            
            btn.classList.remove('btn-loading');
            btn.disabled = false;
            
            if (result.success) {
                window.firebaseAuth.closeAuthModal();
            }
        }

        // Signup handler
        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const btn = document.getElementById('signupBtn');
            
            if (password !== confirmPassword) {
                Swal.fire({
                    icon: 'error',
                    title: 'Passwords do not match',
                    text: 'Please make sure both passwords are the same'
                });
                return;
            }
            
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            const result = await window.firebaseAuth.signUp(email, password, name);
            
            btn.classList.remove('btn-loading');
            btn.disabled = false;
            
            if (result.success) {
                window.firebaseAuth.closeAuthModal();
            }
        }

        // Google sign in handler
        async function handleGoogleSignIn() {
            const result = await window.firebaseAuth.signInWithGoogle();
            if (result.success) {
                window.firebaseAuth.closeAuthModal();
            }
        }

        // Password reset handler
        async function handleResetPassword() {
            const email = document.getElementById('resetEmail').value;
            if (!email) {
                Swal.fire({
                    icon: 'error',
                    title: 'Email Required',
                    text: 'Please enter your email address'
                });
                return;
            }
            await window.firebaseAuth.resetPassword(email);
        }

        // Save profile handler
        async function handleSaveProfile() {
            const btn = document.getElementById('saveProfileBtn');
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            await window.firebaseAuth.saveProfile();
            
            btn.classList.remove('btn-loading');
            btn.disabled = false;
        }

        // Logout handler
        async function handleLogout() {
            await window.firebaseAuth.logout();
            window.firebaseAuth.closeProfileModal();
        }

        // Update profile modal with user data when opened
        window.firebaseAuth?.onAuthStateChange?.((user) => {
            if (user) {
                const nameEl = document.getElementById('userDisplayName');
                const emailEl = document.getElementById('userDisplayEmail');
                const avatarEl = document.getElementById('userAvatarLarge');
                
                if (nameEl) nameEl.textContent = user.displayName || 'User';
                if (emailEl) emailEl.textContent = user.email || '';
                
                if (avatarEl) {
                    if (user.photoURL) {
                        avatarEl.innerHTML = `<img src="${user.photoURL}" alt="Profile">`;
                    } else {
                        const initial = (user.displayName || user.email || 'U')[0].toUpperCase();
                        avatarEl.innerHTML = initial;
                    }
                }
            }
        });

        // Close modal when clicking outside
        document.getElementById('authModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'authModal') {
                window.firebaseAuth.closeAuthModal();
            }
        });

        document.getElementById('profileModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'profileModal') {
                window.firebaseAuth.closeProfileModal();
            }
        });
    </script>

    <!-- Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCt_mM9mwRg0QJpHC4haH7ZsLspVNJI6XM",
            authDomain: "course-corner.firebaseapp.com",
            projectId: "course-corner",
            storageBucket: "course-corner.firebasestorage.app",
            messagingSenderId: "961706784572",
            appId: "1:961706784572:web:7aa6c24946570ffda59039",
            measurementId: "G-QGJ7NZ31Z0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        
        // Initialize Firestore
        const { getFirestore, collection, addDoc } = await import("https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js");
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseAnalytics = analytics;
        window.firebaseDb = db;
        
        // Helper to save payment to Firestore
        window.savePaymentToFirebase = async function(paymentData) {
            try {
                const docRef = await addDoc(collection(db, "payments"), {
                    ...paymentData,
                    timestamp: new Date().toISOString()
                });
                console.log("💾 Payment saved to Firebase:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Firebase save error:", error);
            }
        };
        
        // Helper to track events
        window.trackFirebaseEvent = function(eventName, params = {}) {
            import("https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js").then(({ logEvent }) => {
                logEvent(analytics, eventName, params);
                console.log("📊 Event:", eventName, params);
            });
        };
        
        console.log('🔥 Firebase initialized successfully');
    </script>
</body>
</html>